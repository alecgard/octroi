<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Octroi</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%231a1a1a' rx='6'/%3E%3Ctext x='16' y='23' font-family='SF Mono,Cascadia Code,Fira Code,monospace' font-size='20' font-weight='700' fill='%23f5f5f0' text-anchor='middle'%3EO%3C/text%3E%3C/svg%3E">
<style>
:root {
  --bg: #ffffff;
  --surface: #f5f5f0;
  --surface2: #eaeae5;
  --border: #d0d0c8;
  --text: #1a1a1a;
  --text2: #707068;
  --accent: #1a1a1a;
  --accent-hover: #444;
  --danger: #c33;
  --danger-hover: #e44;
  --success: #2a7;
  --warn: #a80;
  --font: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 12px;
  line-height: 1.5;
}
/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar h1 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.topbar .spacer { flex: 1; }
.user-info { display: flex; align-items: center; gap: 8px; font-size: 11px; }
.user-info .user-name { font-weight: 600; }
.role-badge {
  display: inline-block;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1px 5px;
  border: 1px solid var(--border);
  color: var(--text2);
}
.role-badge.admin { border-color: var(--warn); color: var(--warn); }
/* Buttons */
button {
  font-family: var(--font);
  cursor: pointer;
  border: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  padding: 4px 10px;
  background: var(--bg);
  color: var(--text);
  transition: background 0.1s;
}
button:hover:not(:disabled) { background: var(--surface2); }
button:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn-danger { background: var(--bg); color: var(--danger); border-color: var(--danger); }
.btn-danger:hover:not(:disabled) { background: #fef0f0; }
.btn-ghost { background: transparent; color: var(--text2); }
.btn-ghost:hover:not(:disabled) { color: var(--text); background: var(--surface); }
.btn-sm { padding: 2px 8px; font-size: 11px; }
.btn-warn { background: var(--bg); color: var(--warn); border-color: var(--warn); }
.btn-warn:hover:not(:disabled) { background: #fef8f0; }
/* Tabs */
.tabs {
  display: flex;
  gap: 0;
  padding: 0 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.tab-btn {
  background: none;
  color: var(--text2);
  border: none;
  border-bottom: 2px solid transparent;
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.tab-btn:hover { color: var(--text); background: none; }
.tab-btn.active { color: var(--text); border-bottom-color: var(--text); font-weight: 700; }
/* Content */
.content { padding: 16px; max-width: 1200px; margin: 0 auto; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
#tab-tools table { table-layout: auto; }
#tab-usage table { table-layout: auto; }
th:last-child, td:last-child { width: 120px; text-align: right; }
thead th {
  text-align: left;
  padding: 6px 8px;
  color: var(--text2);
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  border-bottom: 2px solid var(--border);
}
tbody td {
  padding: 5px 8px;
  border-bottom: 1px solid var(--surface2);
  vertical-align: top;
}
tbody tr:hover { background: var(--surface); }
.mono { font-family: var(--font); font-size: 12px; }
/* Cards */
.cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 12px;
}
.card .label { font-size: 10px; color: var(--text2); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
.card .value { font-size: 20px; font-weight: 700; }
/* Toolbar */
.toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
.toolbar h2, .toolbar-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 200;
  justify-content: center;
  align-items: flex-start;
  padding: 60px 24px;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg);
  border: 1px solid var(--border);
  width: 100%;
  max-width: 520px;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 16px;
}
.modal h3 { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.form-group { margin-bottom: 10px; }
.form-group label {
  display: block;
  font-size: 10px;
  color: var(--text2);
  margin-bottom: 3px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-group input, .form-group textarea {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 8px;
  font-size: 12px;
  font-family: var(--font);
}
.form-group select {
  width: 100%;
  height: 28px;
  font-size: 12px;
  padding: 5px 24px 5px 8px;
}
.form-group textarea { min-height: 50px; resize: vertical; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  outline: none;
  border-color: var(--text);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 14px; }
/* Confirm dialog */
.confirm-modal .modal { max-width: 360px; }
.confirm-modal .confirm-msg { font-size: 12px; line-height: 1.5; margin-bottom: 14px; }
.btn-danger-fill {
  background: #c33; color: #fff; border: 1px solid #c33;
  padding: 4px 14px; font-size: 11px; font-family: var(--font); font-weight: 600; cursor: pointer;
}
.btn-danger-fill:hover { background: #a22; border-color: #a22; }
/* Toast */
.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: var(--text); color: var(--bg); padding: 8px 16px;
  font-size: 11px; font-family: var(--font); z-index: 300;
  opacity: 0; transition: opacity 0.2s;
}
.toast.show { opacity: 1; }
/* Banner */
.banner {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--success);
  padding: 8px 12px;
  margin-bottom: 12px;
  font-size: 12px;
  display: none;
}
.banner.show { display: block; }
.banner .key-value { font-weight: 700; color: var(--text); user-select: all; }
/* Select (global) */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  border: 1px solid var(--border);
  border-radius: 0;
  color: var(--text);
  padding: 3px 8px;
  padding-right: 22px;
  font-size: 11px;
  font-weight: 500;
  font-family: var(--font);
  height: 24px;
  cursor: pointer;
  background: var(--bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23707068'/%3E%3C/svg%3E") no-repeat right 6px center;
}
select:focus { outline: none; border-color: var(--text); }
select:hover { border-color: var(--text2); }
/* Filters */
.filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.multi-select {
  position: relative; display: inline-block; min-width: 120px; font-size: 11px; font-weight: 500;
  background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; user-select: none;
}
.multi-select .ms-display {
  padding: 3px 22px 3px 8px; height: 24px; display: flex; align-items: center; gap: 4px; white-space: nowrap; overflow: hidden;
}
.multi-select .ms-display::after {
  content: '▾'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 9px; color: var(--text2);
}
.multi-select .ms-clear {
  display: none; position: absolute; right: 4px; top: 50%; transform: translateY(-50%);
  font-size: 14px; color: var(--text2); cursor: pointer; padding: 2px 4px; line-height: 1; z-index: 1;
}
.multi-select .ms-clear:hover { color: var(--text); }
.multi-select.has-selection:hover .ms-clear { display: block; }
.multi-select.has-selection:hover .ms-display::after { display: none; }
.multi-select.has-selection:hover .ms-display { padding-right: 22px; }
.multi-select .ms-tag {
  background: var(--surface); border: 1px solid var(--border); border-radius: 3px; padding: 0 5px; font-size: 10px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;
}
.multi-select .ms-dropdown {
  display: none; position: absolute; top: 100%; left: 0; min-width: 100%; max-height: 240px; overflow-y: auto;
  background: var(--bg); border: 1px solid var(--border); border-radius: 4px; margin-top: 2px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.multi-select.open .ms-dropdown { display: block; }
.multi-select .ms-option {
  padding: 4px 8px; display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px;
}
.multi-select .ms-option:hover { background: var(--surface); }
.multi-select .ms-option .ms-check {
  width: 12px; height: 12px; border: 1px solid var(--border); border-radius: 2px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.multi-select .ms-option.selected .ms-check { background: var(--text); border-color: var(--text); }
.multi-select .ms-option.selected .ms-check::after { content: '✓'; color: var(--bg); font-size: 9px; }
.multi-select .ms-search {
  width: 100%; box-sizing: border-box; padding: 4px 8px; border: none; border-bottom: 1px solid var(--border);
  font-size: 11px; font-family: var(--font); background: var(--bg); color: var(--text); outline: none;
}
.filters input[type="date"] {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 3px 8px;
  font-size: 11px;
  font-weight: 500;
  font-family: var(--font);
  height: 24px;
}
/* Empty state */
.empty { text-align: center; padding: 32px; color: var(--text2); font-size: 12px; }
/* Login screen */
#login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80vh;
}
.login-box {
  width: 320px;
  border: 1px solid var(--border);
  padding: 24px;
  background: var(--surface);
}
.login-box h2 {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  text-align: center;
}
.login-error {
  color: var(--danger);
  font-size: 11px;
  margin-bottom: 8px;
  display: none;
}
/* Links */
a { color: var(--text); }
a:hover { color: var(--text2); }
/* Usage mode toggle */
.usage-mode-toggle { display: flex; gap: 0; margin-left: 12px; }
.mode-btn {
  background: var(--bg);
  border: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  padding: 3px 12px;
  height: 24px;
  color: var(--text2);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
}
.mode-btn:first-child { border-radius: 3px 0 0 3px; }
.mode-btn:last-child { border-radius: 0 3px 3px 0; border-left: none; }
.mode-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 700; }
.live-dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #2a7;
}
.mode-btn.active .live-dot { background: #5fffaa; animation: pulse 1.5s infinite; }
body.shift-held .mode-btn.active .live-dot, body.chart-paused .mode-btn.active .live-dot { background: #f0c040; animation: none; }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
@keyframes fadeIn {
  from { background: rgba(42, 119, 77, 0.12); }
  to { background: transparent; }
}
.txn-new { animation: fadeIn 1.2s ease-out; }
.txn-filterable { position: relative; cursor: default; }
.txn-filter-icon {
  display: inline;
  visibility: hidden;
  cursor: pointer;
  margin-left: 4px;
  opacity: 0.4;
  font-size: 10px;
  vertical-align: middle;
}
.txn-filterable:hover .txn-filter-icon { visibility: visible; }
.txn-filter-icon:hover { opacity: 1; }
.txn-filterable:hover .txn-filter-active, body.shift-held .txn-filter-active { opacity: 1; }
/* Show all filter icons when shift is held */
body.shift-held .txn-filter-icon { visibility: visible; }
/* Highlight pending selections */
body.shift-held .txn-filter-pending { background: var(--surface2); }
/* Strikethrough for non-selected items when filters are active */
.txn-excluded { text-decoration: line-through; color: var(--text2); }
.chart-legend-excluded { text-decoration: line-through; color: var(--text2); opacity: 0.5; }
/* Filter pills */
/* Team cards */
.team-section {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 12px;
  margin-bottom: 12px;
  width: fit-content;
  min-width: 320px;
}
.team-section h3 {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.team-section .team-sub {
  font-size: 10px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 8px 0 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.team-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.team-section li {
  padding: 2px 0;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  min-height: 22px;
}
.team-section li .btn-sm { margin-left: 8px; flex-shrink: 0; }
.team-section li .team-user-name {
  display: inline-block;
  width: 280px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex-shrink: 0;
  position: relative;
  cursor: default;
}
.team-section li .team-user-name .tip {
  display: none; position: absolute; bottom: 100%; left: 0;
  background: var(--text); color: var(--bg); padding: 4px 8px; font-size: 10px;
  font-weight: 400; white-space: nowrap; z-index: 10; margin-bottom: 4px;
}
.team-section li .team-user-name:hover .tip { display: block; }
.team-section li .role-badge { width: 52px; text-align: center; box-sizing: border-box; flex-shrink: 0; }
.team-section li .mono {
  color: var(--text2);
  font-size: 11px;
}
/* Tooltip */
.has-tooltip { position: relative; cursor: help; }
.has-tooltip .tip {
  display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: var(--text); color: var(--bg); padding: 4px 8px; font-size: 10px;
  font-weight: 400; text-transform: none; letter-spacing: 0; white-space: nowrap;
  z-index: 10; margin-bottom: 4px;
}
.has-tooltip:hover .tip { display: block; }
/* Metrics sections */
.metrics-section { margin-bottom: 16px; }
.metrics-section-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text2); margin-bottom: 6px; width: fit-content; }
.metrics-section .cards .card { cursor: help; }
/* Search */
.tab-search {
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  padding: 3px 8px; font-size: 11px; font-family: var(--font); height: 24px; width: 180px;
}
.tab-search:focus { outline: none; border-color: var(--text); }
.tab-search::placeholder { color: var(--text2); }
/* Chart */
.chart-label { font-family: var(--font); font-size: 9px; fill: var(--text2); }
.chart-tick { stroke: var(--border); stroke-dasharray: 3,3; }
.chart-legend { display: flex; gap: 12px; flex-wrap: wrap; padding: 6px 8px 8px; font-size: 10px; color: var(--text); }
.chart-legend-item { display: flex; align-items: center; gap: 4px; cursor: pointer; }
.chart-legend-item:hover { color: var(--text); }
.chart-legend-swatch { width: 10px; height: 10px; display: inline-block; }
.chart-tooltip {
  position: absolute; pointer-events: none; z-index: 50;
  background: var(--bg); border: 1px solid var(--border);
  padding: 6px 10px; font-size: 11px; font-family: var(--font);
  box-shadow: 0 2px 6px rgba(0,0,0,0.08); white-space: nowrap;
}
.chart-tooltip .tt-time { font-weight: 700; margin-bottom: 3px; }
.chart-tooltip .tt-row { display: flex; align-items: center; gap: 5px; line-height: 1.6; }
.chart-tooltip .tt-swatch { width: 8px; height: 8px; display: inline-block; }
#usage-chart { position: relative; }
/* Spinner */
@keyframes spin { to { transform: rotate(360deg); } }
.usage-spinner {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 24px; color: var(--text2); font-size: 11px;
}
.usage-spinner::before {
  content: ''; width: 14px; height: 14px;
  border: 2px solid var(--border); border-top-color: var(--text);
  border-radius: 50%; animation: spin 0.6s linear infinite;
}

</style>
</head>
<body>
<!-- Top Bar -->
<div class="topbar">
  <h1>octroi</h1>
  <div class="spacer"></div>
  <div class="user-info" id="user-info" style="display:none">
    <span class="user-name" id="topbar-user-name"></span>
    <span class="role-badge" id="topbar-role-badge"></span>
    <button class="btn-ghost btn-sm" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-box">
    <h2>octroi</h2>
    <div class="login-error" id="login-error"></div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="admin@octroi.dev" autocomplete="email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
    </div>
    <div style="margin-top:12px">
      <button class="btn-primary" style="width:100%" id="login-btn" onclick="doLogin()">Connect</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" id="tab-bar" style="display:none">
  <button class="tab-btn active" data-tab="agents">Agents</button>
  <button class="tab-btn" data-tab="tools">Tools</button>
  <button class="tab-btn" data-tab="usage">Usage</button>
  <button class="tab-btn" data-tab="teams">Teams</button>
  <button class="tab-btn" data-tab="users">Users</button>
  <button class="tab-btn" data-tab="metrics" id="metrics-tab-btn">Metrics</button>
</div>

<!-- Content -->
<div class="content" id="main-content" style="display:none">
  <!-- Agents Tab -->
  <div class="tab-panel active" id="tab-agents">
    <div class="banner" id="agent-key-banner">
      API key (shown once, copy now): <span class="key-value" id="agent-key-value"></span>
    </div>
    <div style="display:flex;align-items:center;margin-bottom:8px;gap:8px">
      <h2 class="toolbar-title">Agents</h2>
      <input type="text" class="tab-search" id="agents-search" placeholder="Search agents..." oninput="renderAgents()">
      <select class="styled-select" id="agents-team-filter" onchange="renderAgents()">
        <option value="">All teams</option>
      </select>
      <div style="flex:1"></div>
      <button class="btn-primary" onclick="openAgentModal()">+ Create Agent</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Team</th>
          <th class="has-tooltip">Rate Limit (req/min)<span class="tip">Global limit for this agent across all tools</span></th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="agents-body"></tbody>
    </table>
    <div class="empty" id="agents-empty" style="display:none">No agents created yet.</div>
  </div>

  <!-- Tools Tab -->
  <div class="tab-panel" id="tab-tools">
    <div style="display:flex;align-items:center;margin-bottom:8px;gap:8px">
      <h2 class="toolbar-title">Tools</h2>
      <input type="text" class="tab-search" id="tools-search" placeholder="Search tools..." oninput="renderTools()">
      <div style="flex:1"></div>
      <button class="btn-primary" id="tools-create-btn" onclick="openToolModal()">+ Create Tool</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th id="tools-type-th">Type</th>
          <th id="tools-endpoint-th">Endpoint</th>
          <th>Auth</th>
          <th>Total Calls</th>
          <th id="tools-actions-th"></th>
        </tr>
      </thead>
      <tbody id="tools-body"></tbody>
    </table>
    <div class="empty" id="tools-empty" style="display:none">No tools registered yet.</div>
  </div>

  <!-- Teams Tab -->
  <div class="tab-panel" id="tab-teams">
    <div style="display:flex;align-items:center;margin-bottom:8px;gap:8px">
      <h2 class="toolbar-title">Teams</h2>
      <input type="text" class="tab-search" id="teams-search" placeholder="Search teams..." oninput="renderTeams()">
      <div style="flex:1"></div>
      <button class="btn-primary" id="teams-create-btn" onclick="openCreateTeamModal()">+ Create Team</button>
    </div>
    <div id="teams-content"></div>
    <div class="empty" id="teams-empty" style="display:none">No teams found.</div>
  </div>

  <!-- Usage Tab -->
  <div class="tab-panel" id="tab-usage">
    <div class="toolbar" style="margin-bottom:4px">
      <h2>Usage</h2>
    </div>
    <div class="filters" style="margin-bottom:12px">
      <div class="multi-select" id="usage-team-select" data-placeholder="All teams"></div>
      <div class="multi-select" id="usage-agent-select" data-placeholder="All agents"></div>
      <div class="multi-select" id="usage-tool-select" data-placeholder="All tools"></div>
      <div style="flex:1"></div>
      <div id="usage-date-controls" style="display:none;gap:8px;align-items:center">
        <input type="date" id="usage-from">
        <span style="color:var(--text2)">to</span>
        <input type="date" id="usage-to">
        <button class="btn-ghost" onclick="loadUsage()">Apply</button>
      </div>
      <select id="usage-lookback-select" class="styled-select" onchange="onLookbackChange()">
        <option value="300000">Lookback: 5 min</option>
        <option value="900000">Lookback: 15 min</option>
        <option value="3600000">Lookback: 1 hour</option>
        <option value="21600000">Lookback: 6 hours</option>
        <option value="86400000">Lookback: 24 hours</option>
        <option value="604800000">Lookback: 7 days</option>
      </select>
      <div class="usage-mode-toggle">
        <button class="mode-btn active" id="mode-live" onclick="setUsageMode('live')"><span class="live-dot"></span> Live</button>
        <button class="mode-btn" id="mode-hist" onclick="setUsageMode('historical')">Historical</button>
      </div>
    </div>
    <div class="cards" id="usage-cards">
      <div class="card"><div class="label">Total Requests</div><div class="value" id="stat-requests">&mdash;</div></div>
      <div class="card"><div class="label">Total Cost</div><div class="value" id="stat-cost">&mdash;</div></div>
      <div class="card"><div class="label">Avg Latency</div><div class="value" id="stat-latency">&mdash;</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <h3 style="font-size:14px;font-weight:600">Requests Over Time</h3>
      <div style="flex:1"></div>
      <select id="usage-bucket-select" class="styled-select" onchange="onBucketChange()">
        <option value="30000">Bucket: 30 sec</option>
        <option value="60000">Bucket: 1 min</option>
        <option value="300000">Bucket: 5 min</option>
        <option value="900000">Bucket: 15 min</option>
        <option value="3600000">Bucket: 1 hour</option>
        <option value="86400000">Bucket: 1 day</option>
      </select>
      <div class="usage-mode-toggle">
        <button class="mode-btn active" id="chart-by-agent" onclick="setChartGroup('agent')">By Agent</button>
        <button class="mode-btn" id="chart-by-tool" onclick="setChartGroup('tool')">By Tool</button>
      </div>
    </div>
    <div id="usage-chart" style="width:100%;margin-bottom:16px;border:1px solid var(--border);background:var(--surface);overflow:hidden"></div>
    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px;">Transactions</h3>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Team</th>
          <th>Agent</th>
          <th>Tool</th>
          <th>Method</th>
          <th>Path</th>
          <th>Latency</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody id="txn-body"></tbody>
    </table>
    <div class="empty" id="txn-empty" style="display:none">No transactions found.</div>
    <div id="txn-pagination" style="display:none;align-items:center;justify-content:flex-end;margin-top:12px;font-size:13px;color:var(--text2);gap:8px">
      <span id="txn-page-info"></span>
      <button class="btn-ghost" id="txn-prev" onclick="txnPrevPage()" style="padding:4px 8px">&laquo; Prev</button>
      <button class="btn-ghost" id="txn-next" onclick="txnNextPage()" style="padding:4px 8px">Next &raquo;</button>
    </div>
  </div>

  <!-- Users Tab (org_admin only) -->
  <div class="tab-panel" id="tab-users">
    <div style="display:flex;align-items:center;margin-bottom:8px;gap:8px">
      <h2 class="toolbar-title">Users</h2>
      <input type="text" class="tab-search" id="users-search" placeholder="Search users..." oninput="renderUsers()">
      <div style="flex:1"></div>
      <button class="btn-primary" id="users-create-btn" onclick="openUserModal()">+ Create User</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Teams</th>
          <th>Role</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>
    <div class="empty" id="users-empty" style="display:none">No users created yet.</div>
  </div>

  <!-- Metrics Tab (admin only) -->
  <div class="tab-panel" id="tab-metrics">
    <div class="toolbar" style="margin-bottom:4px">
      <h2>Metrics</h2>
    </div>
    <div style="font-size:11px;color:var(--text2);margin-bottom:8px">In-memory counters for this instance — resets on restart.</div>
    <div id="metrics-cards">
      <div class="empty">Loading metrics...</div>
    </div>
  </div>
</div>

<!-- Tool Modal -->
<div class="modal-overlay" id="tool-modal">
  <div class="modal">
    <h3 id="tool-modal-title">Create Tool</h3>
    <input type="hidden" id="tool-edit-id">
    <div class="form-group" id="tool-id-group" style="display:none">
      <label>Tool ID</label>
      <code id="tool-id-display" style="display:block;padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-radius:4px;font-size:12px;color:var(--text2);user-select:all"></code>
    </div>
    <div class="form-group">
      <label>Mode</label>
      <select id="tool-mode" onchange="toggleToolMode()">
        <option value="service">Service</option>
        <option value="api">API</option>
      </select>
    </div>
    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="tool-name" placeholder="e.g. Open Weather Data">
    </div>
    <div class="form-group">
      <label>Description *</label>
      <input type="text" id="tool-description" placeholder="What this tool does">
    </div>
    <div class="form-group">
      <label>Endpoint *</label>
      <input type="url" id="tool-endpoint" placeholder="https://api.example.com/v1">
    </div>
    <div class="form-group" id="tool-variables-section" style="display:none">
      <label>Variables (JSON)</label>
      <textarea id="tool-variables" placeholder='{"instance": "mycompany"}'></textarea>
      <span style="font-size:10px;color:var(--text2)">Key-value pairs for {placeholder} substitution in the endpoint URL</span>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Auth Type *</label>
        <select id="tool-auth-type">
          <option value="none">none</option>
          <option value="bearer">bearer</option>
          <option value="header">header</option>
          <option value="query">query</option>
        </select>
      </div>
      <div class="form-group">
        <label title="Max requests per minute across ALL agents combined. A shared ceiling for this tool.">Global Rate Limit (req/min)</label>
        <input type="number" id="tool-rate-limit" placeholder="0">
      </div>
    </div>
    <div class="form-group" id="tool-rate-overrides-section" style="display:none">
      <label title="Max requests per minute shared by all agents on a team. Must also stay within the global limit.">Team Rate Limit Overrides</label>
      <div id="tool-team-overrides"></div>
      <button type="button" class="btn-ghost" onclick="addToolRateOverrideRow('team')" style="font-size:12px;margin-top:4px">+ Add Team Override</button>
      <label style="margin-top:8px" title="Max requests per minute for a single agent. Must also stay within team and global limits.">Agent Rate Limit Overrides</label>
      <div id="tool-agent-overrides"></div>
      <button type="button" class="btn-ghost" onclick="addToolRateOverrideRow('agent')" style="font-size:12px;margin-top:4px">+ Add Agent Override</button>
    </div>
    <div class="form-group">
      <label>Auth Config (JSON)</label>
      <textarea id="tool-auth-config" placeholder='{"token": "sk-..."}'></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Pricing Model</label>
        <select id="tool-pricing-model">
          <option value="">none</option>
          <option value="per_request">per_request</option>
        </select>
      </div>
      <div class="form-group">
        <label>Pricing Amount</label>
        <input type="number" step="any" id="tool-pricing-amount" placeholder="0.00">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Pricing Currency</label>
        <input type="text" id="tool-pricing-currency" placeholder="USD">
      </div>
      <div class="form-group">
        <label>Budget Limit</label>
        <input type="number" step="any" id="tool-budget-limit" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label>Budget Window</label>
      <select id="tool-budget-window">
        <option value="">none</option>
        <option value="daily">daily</option>
        <option value="monthly">monthly</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('tool-modal')">Cancel</button>
      <button class="btn-primary" id="tool-submit-btn" onclick="submitTool()">Create</button>
    </div>
  </div>
</div>

<!-- Agent Modal -->
<div class="modal-overlay" id="agent-modal">
  <div class="modal">
    <h3 id="agent-modal-title">Create Agent</h3>
    <input type="hidden" id="agent-edit-id">
    <div class="form-group" id="agent-key-group" style="display:none">
      <label>Key</label>
      <div class="mono" id="agent-key-display" style="padding:4px 0;color:var(--text2)"></div>
    </div>
    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="agent-name" placeholder="e.g. my-scraper">
    </div>
    <div class="form-row">
      <div class="form-group" id="agent-team-group">
        <label>Team</label>
        <input type="text" id="agent-team" placeholder="e.g. backend">
      </div>
      <div class="form-group">
        <label>Rate Limit (req/min)</label>
        <input type="number" id="agent-rate-limit" placeholder="0">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-warn" id="agent-regen-btn" onclick="regenKeyFromModal()" style="display:none;margin-right:auto">Regenerate Key</button>
      <button class="btn-ghost" onclick="closeModal('agent-modal')">Cancel</button>
      <button class="btn-primary" id="agent-submit-btn" onclick="submitAgent()">Create</button>
    </div>
  </div>
</div>

<!-- User Modal -->
<div class="modal-overlay" id="user-modal">
  <div class="modal">
    <h3 id="user-modal-title">Create User</h3>
    <input type="hidden" id="user-edit-id">
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="user-email" placeholder="user@example.com">
    </div>
    <div class="form-group" id="user-password-group">
      <label>Password *</label>
      <input type="password" id="user-password" placeholder="Password">
    </div>
    <div id="user-change-password-group" style="display:none;border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
      <div class="form-group">
        <label>Current Password</label>
        <input type="password" id="user-current-password" placeholder="Current password">
      </div>
      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="user-new-password" placeholder="New password (min 6 chars)">
      </div>
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="user-name-input" placeholder="Full name">
    </div>
    <div class="form-group">
      <label>Role</label>
      <select id="user-role">
        <option value="member">member</option>
        <option value="org_admin">org_admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('user-modal')">Cancel</button>
      <button class="btn-primary" id="user-submit-btn" onclick="submitUser()">Create</button>
    </div>
  </div>
</div>

<!-- Add Team Member Modal -->
<div class="modal-overlay" id="add-member-modal">
  <div class="modal">
    <h3>Add Team Member</h3>
    <input type="hidden" id="add-member-team">
    <div class="form-group">
      <label>User</label>
      <select id="add-member-user"></select>
    </div>
    <div class="form-group">
      <label>Team Role</label>
      <select id="add-member-role">
        <option value="member">member</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('add-member-modal')">Cancel</button>
      <button class="btn-primary" onclick="submitAddMember()">Add</button>
    </div>
  </div>
</div>

<!-- Create Team Modal -->
<div class="modal-overlay" id="create-team-modal">
  <div class="modal">
    <h3>Create Team</h3>
    <div class="form-group">
      <label>Team Name *</label>
      <input type="text" id="create-team-name" placeholder="e.g. backend">
    </div>
    <div class="form-group">
      <label>First Admin *</label>
      <select id="create-team-admin"></select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('create-team-modal')">Cancel</button>
      <button class="btn-primary" onclick="submitCreateTeam()">Create</button>
    </div>
  </div>
</div>

<div class="modal-overlay confirm-modal" id="confirm-modal">
  <div class="modal">
    <h3 id="confirm-title">Confirm</h3>
    <div class="confirm-msg" id="confirm-msg"></div>
    <div class="modal-actions">
      <button class="btn-ghost" id="confirm-cancel">Cancel</button>
      <button class="btn-danger-fill" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// --- Confirm / Toast helpers ---
function appConfirm(msg, { title = 'Confirm', okLabel = 'Delete' } = {}) {
  return new Promise(resolve => {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-msg').textContent = msg;
    const okBtn = document.getElementById('confirm-ok');
    okBtn.textContent = okLabel;
    okBtn.className = okLabel === 'Delete' || okLabel === 'Remove' ? 'btn-danger-fill' : 'btn-primary';
    document.getElementById('confirm-modal').classList.add('open');
    const cleanup = (val) => {
      document.getElementById('confirm-modal').classList.remove('open');
      okBtn.onclick = null;
      document.getElementById('confirm-cancel').onclick = null;
      resolve(val);
    };
    okBtn.onclick = () => cleanup(true);
    document.getElementById('confirm-cancel').onclick = () => cleanup(false);
  });
}

function toast(msg, ms = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), ms);
}

// --- State ---
let authToken = localStorage.getItem('octroi_session_token') || '';
let authMode = ''; // 'session' when logged in
let currentUser = null; // { id, email, name, teams, role }
let isAdmin = false;
let usageAgentIds = [];    // array of agent UUIDs
let usageToolIds = [];     // array of tool UUIDs
let usageTeamFilters = []; // array of team names
let usageMode = 'live'; // 'live' or 'historical'
let usagePollTimer = null;
let lastTxnTimestamp = null;
let usageLoading = false;
let chartLegendHover = false;
let liveLookback = parseInt(localStorage.getItem('octroi_live_lookback')) || 86400000;
let txnPageSize = 50;
let txnAll = []; // current page rows
let txnNextCursor = null;
let txnCursorStack = []; // stack of cursors for previous pages
let txnTotal = 0; // from summary total_requests
let txnOffset = 0; // current page start index (0-based)
let txnBasePath = ''; // base transaction query path (without cursor/limit)
let agentsCache = [];
let toolsCache = [];
let teamsCache = [];
let toolCallCounts = {};
let usersCache = [];

// --- Shift-key multi-select state ---
let shiftHeld = false;
let pendingFilters = { teams: new Set(), agents: new Set(), tools: new Set() };

document.addEventListener('keydown', e => {
  if (e.key === 'Shift' && !shiftHeld) {
    shiftHeld = true;
    document.body.classList.add('shift-held');
    stopUsagePoll();
  }
});
document.addEventListener('keyup', e => {
  if (e.key === 'Shift' && shiftHeld) {
    shiftHeld = false;
    document.body.classList.remove('shift-held');
    // Apply pending filters if any
    let changed = false;
    if (pendingFilters.teams.size) {
      pendingFilters.teams.forEach(t => {
        const idx = usageTeamFilters.indexOf(t);
        if (idx >= 0) usageTeamFilters.splice(idx, 1);
        else usageTeamFilters.push(t);
      });
      changed = true;
    }
    if (pendingFilters.agents.size) {
      pendingFilters.agents.forEach(a => {
        const idx = usageAgentIds.indexOf(a);
        if (idx >= 0) usageAgentIds.splice(idx, 1);
        else usageAgentIds.push(a);
      });
      changed = true;
    }
    if (pendingFilters.tools.size) {
      pendingFilters.tools.forEach(t => {
        const idx = usageToolIds.indexOf(t);
        if (idx >= 0) usageToolIds.splice(idx, 1);
        else usageToolIds.push(t);
      });
      changed = true;
    }
    pendingFilters = { teams: new Set(), agents: new Set(), tools: new Set() };
    // Remove pending highlights
    document.querySelectorAll('.txn-filter-pending').forEach(el => el.classList.remove('txn-filter-pending'));
    if (changed) {
      syncDropdowns();
      renderFilterPills();
    }
    // Resume live polling if in live mode, with an immediate fetch.
    if (usageMode === 'live') {
      loadUsageLive();
      startUsagePoll();
    } else if (changed) {
      loadUsage();
    }
  }
});

// Sync dropdowns: when multi-select is active, clear dropdown; otherwise set single value.
function syncDropdowns() {
  msUpdateDisplay('usage-team-select', usageTeamFilters, v => v);
  msUpdateDisplay('usage-agent-select', usageAgentIds, resolveAgentName);
  msUpdateDisplay('usage-tool-select', usageToolIds, resolveToolName);
}

function msRender(id, options, selectedArr, resolveName, onToggle, onClear) {
  const el = document.getElementById(id);
  const placeholder = el.dataset.placeholder || 'All';
  options.sort((a, b) => a.label.localeCompare(b.label));
  let dropdown = '<div class="ms-dropdown">';
  dropdown += '<input type="text" class="ms-search" placeholder="Search..." onclick="event.stopPropagation()">';
  options.forEach(opt => {
    const val = opt.value;
    const label = esc(opt.label);
    const sel = selectedArr.includes(val) ? ' selected' : '';
    dropdown += `<div class="ms-option${sel}" data-value="${esc(val)}" data-label="${label.toLowerCase()}"><span class="ms-check"></span>${label}</div>`;
  });
  dropdown += '</div>';
  const display = '<div class="ms-display">' + msDisplayText(selectedArr, resolveName, placeholder) + '</div>';
  const clearBtn = '<span class="ms-clear">&times;</span>';
  el.innerHTML = display + clearBtn + dropdown;
  el.classList.toggle('has-selection', selectedArr.length > 0);
  el._msClear = onToggle;
  el.querySelectorAll('.ms-option').forEach(opt => {
    opt.addEventListener('click', e => {
      e.stopPropagation();
      onToggle(opt.dataset.value);
    });
  });
  el.querySelector('.ms-search').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    el.querySelectorAll('.ms-option').forEach(opt => {
      opt.style.display = opt.dataset.label.includes(q) ? '' : 'none';
    });
  });
  el.querySelector('.ms-clear').addEventListener('click', e => {
    e.stopPropagation();
    if (onClear) onClear();
  });
  el.querySelector('.ms-display').addEventListener('click', e => {
    e.stopPropagation();
    document.querySelectorAll('.multi-select.open').forEach(ms => { if (ms !== el) ms.classList.remove('open'); });
    el.classList.toggle('open');
    if (el.classList.contains('open')) {
      const search = el.querySelector('.ms-search');
      search.value = '';
      search.dispatchEvent(new Event('input'));
      setTimeout(() => search.focus(), 0);
    }
  });
}

function msDisplayText(selectedArr, resolveName, placeholder) {
  if (!selectedArr.length) return `<span style="color:var(--text2)">${placeholder}</span>`;
  if (selectedArr.length === 1) return esc(resolveName(selectedArr[0]));
  return `<span class="ms-tag">${esc(resolveName(selectedArr[0]))}</span><span style="color:var(--text2)">+${selectedArr.length - 1}</span>`;
}

function msUpdateDisplay(id, selectedArr, resolveName) {
  const el = document.getElementById(id);
  const placeholder = el.dataset.placeholder || 'All';
  const display = el.querySelector('.ms-display');
  if (display) display.innerHTML = msDisplayText(selectedArr, resolveName, placeholder);
  el.classList.toggle('has-selection', selectedArr.length > 0);
  el.querySelectorAll('.ms-option').forEach(opt => {
    opt.classList.toggle('selected', selectedArr.includes(opt.dataset.value));
  });
}

// Render filter pills
function renderFilterPills() {}

// Compute the effective (preview) filter sets: committed state with pending toggles applied.
function effectiveFilters() {
  function toggle(arr, pending) {
    const result = new Set(arr);
    pending.forEach(v => { if (result.has(v)) result.delete(v); else result.add(v); });
    return Array.from(result);
  }
  return {
    teams: toggle(usageTeamFilters, pendingFilters.teams),
    agents: toggle(usageAgentIds, pendingFilters.agents),
    tools: toggle(usageToolIds, pendingFilters.tools),
  };
}

// --- API helpers ---
function apiBase() {
  return isAdmin ? '/api/v1/admin' : '/api/v1/member';
}

function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
  };
  if (body) opts.body = JSON.stringify(body);
  return fetch(path, opts).then(async r => {
    if (r.status === 204) return null;
    if (r.status === 401 && authMode === 'session') {
      clearSession();
      location.reload();
      throw new Error('Session expired');
    }
    const data = await r.json();
    if (!r.ok) throw new Error((data.error && data.error.message) || r.statusText);
    return data;
  });
}

// --- Helpers for TeamMembership ---
function userTeamNames(u) {
  if (!u || !u.teams) return [];
  return u.teams.map(t => typeof t === 'string' ? t : t.team);
}

function userInTeam(u, team) {
  return userTeamNames(u).includes(team);
}

function canManageTeam(team) {
  if (!currentUser) return false;
  if (currentUser.role === 'org_admin') return true;
  if (!currentUser.teams) return false;
  return currentUser.teams.some(t => t.team === team && t.role === 'admin');
}

// --- Session persistence ---
function saveSession() {
  localStorage.setItem('octroi_session_token', authToken);
  if (currentUser) {
    localStorage.setItem('octroi_user', JSON.stringify(currentUser));
  } else {
    localStorage.removeItem('octroi_user');
  }
}

function clearSession() {
  localStorage.removeItem('octroi_session_token');
  localStorage.removeItem('octroi_user');
}

// --- Login ---
async function doLogin() {
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';

  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) return;
  try {
    const res = await fetch('/api/v1/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error((data.error && data.error.message) || 'Login failed');
    authToken = data.token;
    authMode = 'session';
    currentUser = data.user;
    isAdmin = currentUser.role === 'org_admin';
    saveSession();
    enterApp();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  }
}

function enterApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('tab-bar').style.display = 'flex';
  document.getElementById('main-content').style.display = 'block';

  // Topbar user info
  const infoEl = document.getElementById('user-info');
  infoEl.style.display = 'flex';
  const nameEl = document.getElementById('topbar-user-name');
  const badgeEl = document.getElementById('topbar-role-badge');
  if (currentUser) {
    nameEl.textContent = currentUser.name || currentUser.email;
    const roleLabel = currentUser.role === 'org_admin' ? 'org admin' : currentUser.role;
    badgeEl.textContent = roleLabel;
    badgeEl.className = 'role-badge' + (currentUser.role === 'org_admin' ? ' admin' : '');
  }

  // Permission-based UI: disable (not hide) actions the user can't perform.
  const adminOnlyBtns = ['tools-create-btn', 'teams-create-btn', 'users-create-btn', 'metrics-tab-btn'];
  adminOnlyBtns.forEach(id => {
    const btn = document.getElementById(id);
    btn.disabled = !isAdmin;
    btn.title = isAdmin ? '' : 'Org admin only';
  });
  if (!isAdmin) {
    // Hide agent team field for members (UX simplification, not permission)
    document.getElementById('agent-team-group').style.display = 'none';
  }

  loadAgents();
  loadTools();
  loadTeams();
  loadUsage();
  loadUsers();
  onHashChange();
}

async function logout() {
  stopUsagePoll();
  stopMetricsPoll();
  if (authMode === 'session') {
    try { await api('POST', '/api/v1/auth/logout'); } catch (e) { /* ignore */ }
  }
  authToken = '';
  authMode = '';
  currentUser = null;
  isAdmin = false;
  clearSession();
  location.reload();
}

// Handle Enter key in login fields
document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('login-email').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('login-password').focus(); });

// Auto-reconnect from stored session.
// Validate with /auth/me before entering the app to avoid unauthenticated requests.
(function autoConnect() {
  const storedToken = localStorage.getItem('octroi_session_token');
  if (!storedToken) return;

  authToken = storedToken;

  // Validate session before entering app
  api('GET', '/api/v1/auth/me').then(data => {
    currentUser = data;
    isAdmin = currentUser.role === 'org_admin';
    authMode = 'session';
    saveSession();
    enterApp();
  }).catch(() => {
    clearSession();
    authToken = '';
  });
})();

// --- Tabs (hash-routed) ---
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const btn = document.querySelector('[data-tab="' + tab + '"]');
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('tab-' + tab);
  if (panel) panel.classList.add('active');
  // Stop live polling when leaving usage/metrics tabs.
  if (tab !== 'usage') stopUsagePoll();
  if (tab !== 'metrics') stopMetricsPoll();
  // Reload data when switching tabs.
  if (tab === 'usage') {
    loadUsage();
    if (usageMode === 'live') startUsagePoll();
  }
  else if (tab === 'agents') loadAgents();
  else if (tab === 'tools') loadTools();
  else if (tab === 'teams') loadTeams();
  else if (tab === 'users') loadUsers();
  else if (tab === 'metrics') {
    loadMetrics();
    startMetricsPoll();
  }
}

function navigateTo(hash) {
  location.hash = hash;
}

function onHashChange() {
  const hash = location.hash.replace('#', '') || 'agents';
  switchTab(hash);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => navigateTo(btn.dataset.tab));
});

window.addEventListener('hashchange', onHashChange);

// --- Tools ---
async function loadTools() {
  if (!currentUser) return;
  try {
    const path = isAdmin ? '/api/v1/admin/tools?limit=100' : '/api/v1/member/tools?limit=100';
    const data = await api('GET', path);
    toolsCache = data.tools || [];
    renderTools();
    populateToolFilter();
    // Load total call counts for the tools table.
    if (isAdmin) {
      try {
        const counts = await api('GET', '/api/v1/admin/usage/tools/calls');
        toolCallCounts = counts.counts || {};
        renderTools();
      } catch (e2) { console.error('Failed to load tool call counts', e2); }
    }
  } catch (e) { console.error('Failed to load tools', e); }
}

function renderTools() {
  const tbody = document.getElementById('tools-body');
  const empty = document.getElementById('tools-empty');
  const q = (document.getElementById('tools-search').value || '').toLowerCase();
  const filtered = toolsCache.filter(t => !q || t.name.toLowerCase().includes(q) || (t.description || '').toLowerCase().includes(q));
  if (!filtered.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  const disAttr = isAdmin ? '' : ' disabled title="Org admin only"';
  tbody.innerHTML = filtered.map(t => `<tr>
    <td><a href="#" onclick="viewToolUsage('${t.id}','${esc(t.name)}');return false" style="text-decoration:none;font-weight:700;border-bottom:1px solid var(--border)">${esc(t.name)}</a><br><span style="color:var(--text2);font-size:11px">${esc(t.description || '')}</span></td>
    <td>${isAdmin ? (t.mode === 'api' ? 'API' : 'Service') : (t.mode === 'api' ? 'API' : 'Service')}</td>
    <td class="mono" style="word-break:break-all;max-width:220px">${isAdmin ? esc(t.endpoint || '\u2014') : esc(t.pricing_model || 'free')}</td>
    <td>${esc(t.auth_type || 'none')}</td>
    <td>${toolCallCounts[t.id] != null ? Number(toolCallCounts[t.id]).toLocaleString() : '\u2014'}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editTool('${t.id}')"${disAttr}>Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteTool('${t.id}','${esc(t.name)}')"${disAttr}>Delete</button>
    </td>
  </tr>`).join('');

  if (!isAdmin) {
    document.getElementById('tools-endpoint-th').textContent = 'Pricing';
    document.getElementById('tools-type-th').textContent = 'Type';
  }
}

let toolRateOverridesOriginal = []; // track original overrides for diff on save

function toggleToolMode() {
  const mode = document.getElementById('tool-mode').value;
  const varsSection = document.getElementById('tool-variables-section');
  const endpointInput = document.getElementById('tool-endpoint');
  if (mode === 'api') {
    varsSection.style.display = '';
    endpointInput.type = 'text';
    endpointInput.placeholder = 'https://{instance}.example.com/api/{version}';
  } else {
    varsSection.style.display = 'none';
    endpointInput.type = 'url';
    endpointInput.placeholder = 'https://api.example.com/v1';
  }
}

function openToolModal(tool) {
  document.getElementById('tool-edit-id').value = tool ? tool.id : '';
  document.getElementById('tool-id-group').style.display = tool ? '' : 'none';
  document.getElementById('tool-id-display').textContent = tool ? tool.id : '';
  document.getElementById('tool-modal-title').textContent = tool ? 'Edit Tool' : 'Create Tool';
  document.getElementById('tool-submit-btn').textContent = tool ? 'Save' : 'Create';
  document.getElementById('tool-mode').value = tool ? tool.mode || 'service' : 'service';
  document.getElementById('tool-name').value = tool ? tool.name : '';
  document.getElementById('tool-description').value = tool ? tool.description : '';
  document.getElementById('tool-endpoint').value = tool ? tool.endpoint || '' : '';
  document.getElementById('tool-auth-type').value = tool ? tool.auth_type || 'none' : 'none';
  document.getElementById('tool-variables').value = tool && tool.variables && Object.keys(tool.variables).length ? JSON.stringify(tool.variables) : '';
  toggleToolMode();
  document.getElementById('tool-rate-limit').value = tool ? tool.rate_limit || '' : '';
  document.getElementById('tool-auth-config').value = tool && tool.auth_config ? JSON.stringify(tool.auth_config) : '';
  document.getElementById('tool-pricing-model').value = tool ? tool.pricing_model || '' : '';
  document.getElementById('tool-pricing-amount').value = tool ? tool.pricing_amount || '' : '';
  document.getElementById('tool-pricing-currency').value = tool ? tool.pricing_currency || '' : '';
  document.getElementById('tool-budget-limit').value = tool ? tool.budget_limit || '' : '';
  document.getElementById('tool-budget-window').value = tool ? tool.budget_window || '' : '';

  // Rate limit overrides.
  document.getElementById('tool-team-overrides').innerHTML = '';
  document.getElementById('tool-agent-overrides').innerHTML = '';
  toolRateOverridesOriginal = [];
  const overridesSection = document.getElementById('tool-rate-overrides-section');
  if (tool && tool.id) {
    overridesSection.style.display = '';
    loadToolRateOverrides(tool.id);
  } else {
    overridesSection.style.display = 'none';
  }

  document.getElementById('tool-modal').classList.add('open');
}

async function loadToolRateOverrides(toolID) {
  try {
    const data = await api('GET', '/api/v1/admin/tools/' + toolID + '/rate-limits');
    toolRateOverridesOriginal = data.overrides || [];
    document.getElementById('tool-team-overrides').innerHTML = '';
    document.getElementById('tool-agent-overrides').innerHTML = '';
    for (const o of toolRateOverridesOriginal) {
      addToolRateOverrideRow(o.scope, o.scope_id, o.rate_limit);
    }
  } catch (e) { console.error('Failed to load tool rate overrides', e); }
}

function addToolRateOverrideRow(scope, scopeIdVal, rateVal) {
  const container = document.getElementById(scope === 'team' ? 'tool-team-overrides' : 'tool-agent-overrides');
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-top:4px';
  row.dataset.scope = scope;

  let selectHtml = '';
  if (scope === 'team') {
    const options = teamsCache.map(t => '<option value="' + t.name + '"' + (t.name === scopeIdVal ? ' selected' : '') + '>' + t.name + '</option>').join('');
    selectHtml = '<select class="override-scope-id" style="flex:1">' + (scopeIdVal && !teamsCache.find(t => t.name === scopeIdVal) ? '<option value="' + scopeIdVal + '" selected>' + scopeIdVal + '</option>' : '') + options + '</select>';
  } else {
    const options = agentsCache.map(a => '<option value="' + a.id + '"' + (a.id === scopeIdVal ? ' selected' : '') + '>' + a.name + '</option>').join('');
    selectHtml = '<select class="override-scope-id" style="flex:1">' + (scopeIdVal && !agentsCache.find(a => a.id === scopeIdVal) ? '<option value="' + scopeIdVal + '" selected>' + scopeIdVal + '</option>' : '') + options + '</select>';
  }
  row.innerHTML = selectHtml +
    '<input type="number" class="override-rate" placeholder="req/min" value="' + (rateVal || '') + '" style="width:100px">' +
    '<button type="button" class="btn-ghost" onclick="this.parentElement.remove()" style="font-size:12px;padding:2px 6px;color:var(--danger)">✕</button>';
  container.appendChild(row);
}

async function editTool(id) {
  const tool = toolsCache.find(t => t.id === id);
  if (tool) openToolModal(tool);
}

async function submitTool() {
  const id = document.getElementById('tool-edit-id').value;
  let authConfig = {};
  const authConfigRaw = document.getElementById('tool-auth-config').value.trim();
  if (authConfigRaw) {
    try { authConfig = JSON.parse(authConfigRaw); } catch { toast('Invalid auth config JSON'); return; }
  }
  const mode = document.getElementById('tool-mode').value;
  let variables = {};
  const variablesRaw = document.getElementById('tool-variables').value.trim();
  if (variablesRaw) {
    try { variables = JSON.parse(variablesRaw); } catch { toast('Invalid variables JSON'); return; }
  }
  const body = {
    mode: mode,
    name: document.getElementById('tool-name').value.trim(),
    description: document.getElementById('tool-description').value.trim(),
    endpoint: document.getElementById('tool-endpoint').value.trim(),
    auth_type: document.getElementById('tool-auth-type').value,
    auth_config: authConfig,
    variables: variables,
    pricing_model: document.getElementById('tool-pricing-model').value,
    pricing_amount: parseFloat(document.getElementById('tool-pricing-amount').value) || 0,
    pricing_currency: document.getElementById('tool-pricing-currency').value.trim(),
    rate_limit: parseInt(document.getElementById('tool-rate-limit').value) || 0,
    budget_limit: parseFloat(document.getElementById('tool-budget-limit').value) || 0,
    budget_window: document.getElementById('tool-budget-window').value.trim(),
  };
  try {
    if (id) {
      await api('PUT', '/api/v1/admin/tools/' + id, body);
      await saveToolRateOverrides(id);
    } else {
      const created = await api('POST', '/api/v1/admin/tools', body);
      // No overrides to save for a new tool (user can edit after creation).
    }
    closeModal('tool-modal');
    loadTools();
  } catch (e) { toast('Error: ' + e.message); }
}

async function saveToolRateOverrides(toolID) {
  // Collect current overrides from DOM.
  const currentOverrides = [];
  for (const container of [document.getElementById('tool-team-overrides'), document.getElementById('tool-agent-overrides')]) {
    for (const row of container.children) {
      const scope = row.dataset.scope;
      const scopeId = row.querySelector('.override-scope-id').value;
      const rate = parseInt(row.querySelector('.override-rate').value) || 0;
      if (scopeId && rate > 0) {
        currentOverrides.push({ scope, scope_id: scopeId, rate_limit: rate });
      }
    }
  }

  // Determine which original overrides were removed.
  const basePath = '/api/v1/admin/tools/' + toolID + '/rate-limits';
  for (const orig of toolRateOverridesOriginal) {
    const stillExists = currentOverrides.find(c => c.scope === orig.scope && c.scope_id === orig.scope_id);
    if (!stillExists) {
      try { await api('DELETE', basePath + '/' + orig.scope + '/' + encodeURIComponent(orig.scope_id)); } catch(e) { console.error('delete override failed', e); }
    }
  }

  // Upsert current overrides.
  for (const o of currentOverrides) {
    try { await api('PUT', basePath, o); } catch(e) { console.error('set override failed', e); }
  }
}

async function deleteTool(id, name) {
  if (!await appConfirm('Delete tool "' + name + '"?')) return;
  try {
    await api('DELETE', '/api/v1/admin/tools/' + id);
    loadTools();
  } catch (e) { toast('Error: ' + e.message); }
}

// --- Agents ---
async function loadAgents() {
  if (!currentUser) return;
  try {
    const path = apiBase() + '/agents?limit=100';
    const data = await api('GET', path);
    agentsCache = data.agents || [];
    populateAgentsTeamFilter();
    renderAgents();
    populateAgentFilter();
  } catch (e) { console.error('Failed to load agents', e); }
}

function renderAgents() {
  const tbody = document.getElementById('agents-body');
  const empty = document.getElementById('agents-empty');
  const q = (document.getElementById('agents-search').value || '').toLowerCase();
  const teamFilter = document.getElementById('agents-team-filter').value;
  const filtered = agentsCache.filter(a => (!q || a.name.toLowerCase().includes(q) || (a.team || '').toLowerCase().includes(q)) && (!teamFilter || a.team === teamFilter));
  if (!filtered.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = filtered.map(a => `<tr>
    <td><a href="#" onclick="viewAgentUsage('${a.id}','${esc(a.name)}');return false" style="text-decoration:none;font-weight:700;border-bottom:1px solid var(--border)">${esc(a.name)}</a></td>
    <td>${esc(a.team || '\u2014')}</td>
    <td>${a.rate_limit || '\u2014'}</td>
    <td>${fmtDate(a.created_at)}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editAgent('${a.id}')">Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteAgent('${a.id}','${esc(a.name)}')">Delete</button>
    </td>
  </tr>`).join('');
}

function populateAgentsTeamFilter() {
  const sel = document.getElementById('agents-team-filter');
  const current = sel.value;
  const teams = [...new Set(agentsCache.map(a => a.team).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All teams</option>' + teams.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
  sel.value = current;
}

function openAgentModal(ag) {
  document.getElementById('agent-edit-id').value = ag ? ag.id : '';
  document.getElementById('agent-modal-title').textContent = ag ? 'Edit Agent' : 'Create Agent';
  document.getElementById('agent-submit-btn').textContent = ag ? 'Save' : 'Create';
  document.getElementById('agent-name').value = ag ? ag.name : '';
  document.getElementById('agent-team').value = ag ? ag.team || '' : '';
  document.getElementById('agent-rate-limit').value = ag ? ag.rate_limit || '' : '';
  document.getElementById('agent-regen-btn').style.display = ag ? '' : 'none';
  // Show key prefix in edit mode
  const keyGroup = document.getElementById('agent-key-group');
  const keyDisplay = document.getElementById('agent-key-display');
  if (ag && ag.api_key_prefix) {
    keyDisplay.textContent = ag.api_key_prefix + '...';
    keyGroup.style.display = '';
  } else {
    keyGroup.style.display = 'none';
  }
  document.getElementById('agent-modal').classList.add('open');
}

function editAgent(id) {
  const ag = agentsCache.find(a => a.id === id);
  if (ag) openAgentModal(ag);
}

async function submitAgent() {
  const id = document.getElementById('agent-edit-id').value;
  const body = {
    name: document.getElementById('agent-name').value.trim(),
    team: document.getElementById('agent-team').value.trim(),
    rate_limit: parseInt(document.getElementById('agent-rate-limit').value) || 0,
  };
  try {
    if (id) {
      await api('PUT', apiBase() + '/agents/' + id, body);
      closeModal('agent-modal');
    } else {
      const res = await api('POST', apiBase() + '/agents', body);
      closeModal('agent-modal');
      if (res.api_key) {
        document.getElementById('agent-key-value').textContent = res.api_key;
        document.getElementById('agent-key-banner').classList.add('show');
      }
    }
    loadAgents();
  } catch (e) { toast('Error: ' + e.message); }
}

async function regenKeyFromModal() {
  const id = document.getElementById('agent-edit-id').value;
  const name = document.getElementById('agent-name').value;
  if (!id) return;
  if (!await appConfirm('Regenerate API key for "' + name + '"? The old key will stop working immediately.', { title: 'Regenerate Key', okLabel: 'Regenerate' })) return;
  try {
    const res = await api('POST', apiBase() + '/agents/' + id + '/regenerate-key');
    if (res.api_key) {
      document.getElementById('agent-key-value').textContent = res.api_key;
      document.getElementById('agent-key-banner').classList.add('show');
    }
    closeModal('agent-modal');
    loadAgents();
  } catch (e) { toast('Error: ' + e.message); }
}

async function deleteAgent(id, name) {
  if (!await appConfirm('Delete agent "' + name + '"?')) return;
  try {
    await api('DELETE', apiBase() + '/agents/' + id);
    loadAgents();
  } catch (e) { toast('Error: ' + e.message); }
}

// --- Teams ---
async function loadTeams() {
  if (!currentUser) return;
  try {
    const path = apiBase() + '/teams';
    const data = await api('GET', path);
    teamsCache = data.teams || [];
    renderTeams();
    populateTeamFilter();
  } catch (e) { console.error('Failed to load teams', e); }
}

function renderTeams() {
  const container = document.getElementById('teams-content');
  const empty = document.getElementById('teams-empty');
  const q = (document.getElementById('teams-search').value || '').toLowerCase();
  const filtered = teamsCache.filter(t => !q || t.name.toLowerCase().includes(q) ||
    t.agents.some(a => a.name.toLowerCase().includes(q)) ||
    t.users.some(u => (u.name || '').toLowerCase().includes(q) || u.email.toLowerCase().includes(q)));
  if (!filtered.length) { container.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  container.innerHTML = filtered.map(t => {
    const canManage = canManageTeam(t.name);
    const agentList = t.agents.length
      ? t.agents.map(a => `<li><strong>${esc(a.name)}</strong></li>`).join('')
      : '<li style="color:var(--text2)">No agents</li>';
    const userList = t.users.length
      ? t.users.map(u => {
          const teamBadge = `<span class="role-badge${u.team_role === 'admin' ? ' admin' : ''}">${esc(u.team_role || 'member')}</span>`;
          const removeDis = canManage ? '' : ' disabled title="Team admin or org admin only"';
          const nameEmail = u.name ? `${esc(u.name)} &lt;${esc(u.email)}&gt;` : esc(u.email);
          const fullTip = u.name ? `${esc(u.name)} &lt;${esc(u.email)}&gt;` : esc(u.email);
          return `<li><span class="team-user-name">${nameEmail}<span class="tip">${fullTip}</span></span>${teamBadge}<button class="btn-danger btn-sm" onclick="removeTeamMember('${esc(t.name)}','${u.id}','${esc(u.name || u.email)}')"${removeDis}>Remove</button></li>`;
        }).join('')
      : '<li style="color:var(--text2)">No users</li>';

    const addDis = canManage ? '' : ' disabled title="Team admin or org admin only"';
    const addBtn = `<button class="btn-ghost btn-sm" onclick="openAddMemberModal('${esc(t.name)}')"${addDis}>+ Add Member</button>`;

    return `<div class="team-section">
      <h3><a href="#" onclick="viewTeamUsage('${esc(t.name)}');return false" style="text-decoration:none;border-bottom:1px solid var(--border)">${esc(t.name)}</a></h3>
      <div class="team-sub">Agents (${t.agents.length})</div>
      <ul>${agentList}</ul>
      <div class="team-sub">Users (${t.users.length}) ${addBtn}</div>
      <ul>${userList}</ul>
    </div>`;
  }).join('');
}

function openAddMemberModal(team) {
  document.getElementById('add-member-team').value = team;
  document.getElementById('add-member-role').value = 'member';
  // Populate user dropdown, excluding users already in this team.
  const sel = document.getElementById('add-member-user');
  const teamData = teamsCache.find(t => t.name === team);
  const existingIds = new Set(teamData ? teamData.users.map(u => u.id) : []);
  const available = (usersCache.length ? usersCache : []).filter(u => !existingIds.has(u.id) && u.role !== 'org_admin');
  sel.innerHTML = available.map(u => `<option value="${u.id}">${esc(u.name || u.email)} (${esc(u.email)})</option>`).join('');
  if (!available.length) {
    sel.innerHTML = '<option value="">No users available</option>';
  }
  document.getElementById('add-member-modal').classList.add('open');
}

async function submitAddMember() {
  const team = document.getElementById('add-member-team').value;
  const userId = document.getElementById('add-member-user').value;
  const role = document.getElementById('add-member-role').value;
  if (!userId) return;
  try {
    await api('PUT', '/api/v1/member/teams/' + encodeURIComponent(team) + '/members/' + userId, { role });
    closeModal('add-member-modal');
    loadTeams();
    loadUsers();
  } catch (e) { toast('Error: ' + e.message); }
}

async function removeTeamMember(team, userId, userName) {
  if (!await appConfirm('Remove "' + userName + '" from team "' + team + '"?', { title: 'Remove Member', okLabel: 'Remove' })) return;
  try {
    await api('DELETE', '/api/v1/member/teams/' + encodeURIComponent(team) + '/members/' + userId);
    loadTeams();
    loadUsers();
  } catch (e) { toast('Error: ' + e.message); }
}

function openCreateTeamModal() {
  document.getElementById('create-team-name').value = '';
  const sel = document.getElementById('create-team-admin');
  const eligible = (usersCache.length ? usersCache : []).filter(u => u.role !== 'org_admin');
  sel.innerHTML = eligible.map(u => `<option value="${u.id}">${esc(u.name || u.email)} (${esc(u.email)})</option>`).join('');
  if (!eligible.length) {
    sel.innerHTML = '<option value="">No eligible users</option>';
  }
  document.getElementById('create-team-modal').classList.add('open');
}

async function submitCreateTeam() {
  const name = document.getElementById('create-team-name').value.trim();
  const userId = document.getElementById('create-team-admin').value;
  if (!name) { toast('Team name is required'); return; }
  if (!userId) { toast('A first admin is required'); return; }
  // Check if team already exists
  if (teamsCache.some(t => t.name === name)) { toast('Team "' + name + '" already exists'); return; }
  try {
    await api('PUT', '/api/v1/member/teams/' + encodeURIComponent(name) + '/members/' + userId, { role: 'admin' });
    closeModal('create-team-modal');
    loadTeams();
    loadUsers();
  } catch (e) { toast('Error: ' + e.message); }
}

function populateTeamFilter() {
  const options = teamsCache.map(t => ({ value: t.name, label: t.name }));
  msRender('usage-team-select', options, usageTeamFilters, v => v, val => {
    const idx = usageTeamFilters.indexOf(val);
    if (idx >= 0) usageTeamFilters.splice(idx, 1); else usageTeamFilters.push(val);
    syncDropdowns();
    renderFilterPills();
    renderTxnTable();
    renderUsageChart(lastChartTxns);
    loadUsage();
  }, () => {
    usageTeamFilters = [];
    syncDropdowns(); renderFilterPills(); renderTxnTable(); renderUsageChart(lastChartTxns); loadUsage();
  });
}

// --- Usage Mode (Live / Historical) ---
function setUsageMode(mode) {
  usageMode = mode;
  document.getElementById('mode-live').classList.toggle('active', mode === 'live');
  document.getElementById('mode-hist').classList.toggle('active', mode === 'historical');
  document.getElementById('usage-date-controls').style.display = mode === 'historical' ? 'flex' : 'none';
  document.getElementById('usage-lookback-select').style.display = mode === 'live' ? '' : 'none';
  if (mode === 'live') {
    lastTxnTimestamp = null;
    startUsagePoll();
  } else {
    stopUsagePoll();
  }
  loadUsage();
}

function startUsagePoll() {
  stopUsagePoll();
  usagePollTimer = setInterval(loadUsageLive, 3000);
}

function stopUsagePoll() {
  if (usagePollTimer) { clearInterval(usagePollTimer); usagePollTimer = null; }
}

async function loadUsageLive() {
  if (!currentUser) return;
  if (chartLegendHover) return;
  if (!usageLoading && lastTxnTimestamp === null) showUsageLoading();
  const from = new Date(Date.now() - liveLookback).toISOString();
  let qs = '&from=' + encodeURIComponent(from);

  let baseTxnPrefix, usagePath, txnQs;
  if (isAdmin) {
    usagePath = '/api/v1/admin/usage';
    baseTxnPrefix = '/api/v1/admin/usage/transactions?';
    txnQs = qs;
    if (usageTeamFilters.length > 0) {
      const teamParam = '&team=' + encodeURIComponent(usageTeamFilters.join(','));
      qs += teamParam;
      txnQs += teamParam;
    }
    if (usageAgentIds.length > 0) {
      const agentParam = '&agent_id=' + encodeURIComponent(usageAgentIds.join(','));
      qs += agentParam;
      txnQs += agentParam;
    }
    if (usageToolIds.length > 0) {
      const toolParam = '&tool_id=' + encodeURIComponent(usageToolIds.join(','));
      qs += toolParam;
      txnQs += toolParam;
    }
  } else {
    usagePath = '/api/v1/member/usage';
    baseTxnPrefix = '/api/v1/member/usage/transactions?';
    txnQs = qs;
    if (usageTeamFilters.length > 0) {
      txnQs += '&team=' + encodeURIComponent(usageTeamFilters.join(','));
    }
    if (usageToolIds.length > 0) {
      txnQs += '&tool_id=' + encodeURIComponent(usageToolIds.join(','));
    }
  }

  txnBasePath = baseTxnPrefix + 'limit=' + txnPageSize + txnQs;
  const onPage1 = txnOffset === 0;
  try {
    const fetches = [
      api('GET', usagePath + '?' + qs),
      api('GET', baseTxnPrefix + 'limit=5000' + txnQs),
    ];
    // Only re-fetch table data when on page 1; preserve user's position otherwise.
    if (onPage1) fetches.push(api('GET', txnBasePath));
    const results = await Promise.all(fetches);
    const summary = results[0];
    const chartTxns = results[1];
    renderUsageSummary(summary);
    txnTotal = summary.total_requests || 0;
    renderUsageChart((chartTxns.transactions || chartTxns) || txnAll);
    if (onPage1) {
      const tableResp = results[2];
      const prevTimestamp = lastTxnTimestamp;
      txnAll = tableResp.transactions || [];
      txnNextCursor = tableResp.next_cursor || null;
      txnCursorStack = [];
      if (txnAll.length) lastTxnTimestamp = txnAll[0].timestamp;
      renderTxnTable(prevTimestamp);
    } else {
      // Just update the total count display without resetting the table.
      const displayTotal = txnTotal > 0 ? txnTotal : (txnOffset + txnAll.length);
      document.getElementById('txn-page-info').textContent = `${txnOffset + 1}–${txnOffset + txnAll.length} of ${displayTotal}`;
    }
  } catch (e) { console.error('Failed to load live usage', e); hideUsageLoading(); }
}

function renderTxnTable(prevTimestamp) {
  const tbody = document.getElementById('txn-body');
  const empty = document.getElementById('txn-empty');
  const pag = document.getElementById('txn-pagination');
  if (!txnAll.length && txnOffset === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; pag.style.display = 'none'; return; }
  empty.style.display = 'none';
  const ficon = '<svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle"><path d="M1 1h14l-5.5 6.5V14l-3-2V7.5z"/></svg>';
  const fxicon = '<svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle"><path d="M1 1h14l-5.5 6.5V14l-3-2V7.5z"/><line x1="2" y1="14" x2="14" y2="2" stroke="currentColor" stroke-width="2"/></svg>';
  function txnFilterBtn(type, val, rawVal) {
    const active = (type === 'team' && usageTeamFilters.includes(rawVal)) ||
                   (type === 'agent' && usageAgentIds.includes(rawVal)) ||
                   (type === 'tool' && usageToolIds.includes(rawVal));
    if (active) return `<span class="txn-filter-icon txn-filter-active" onclick="removeFilterItem('${type}','${val}',event)" title="Remove from filter">${fxicon}</span>`;
    return `<span class="txn-filter-icon" onclick="filterFromTxn('${type}','${val}',event)" title="Filter by ${type}">${ficon}</span>`;
  }
  const eff = effectiveFilters();
  const hasTeamFilter = eff.teams.length > 0;
  const hasAgentFilter = eff.agents.length > 0;
  const hasToolFilter = eff.tools.length > 0;
  tbody.innerHTML = txnAll.map(t => {
    const isNew = prevTimestamp && t.timestamp > prevTimestamp;
    const teamRaw = resolveAgentTeam(t.agent_id);
    const team = esc(teamRaw);
    const teamExcl = hasTeamFilter && !eff.teams.includes(teamRaw) ? ' txn-excluded' : '';
    const agentExcl = hasAgentFilter && !eff.agents.includes(t.agent_id) ? ' txn-excluded' : '';
    const toolExcl = hasToolFilter && !eff.tools.includes(t.tool_id) ? ' txn-excluded' : '';
    return `<tr${isNew ? ' class="txn-new"' : ''}>
    <td style="white-space:nowrap">${fmtTime(t.timestamp)}</td>
    <td class="txn-filterable${teamExcl}">${team}${txnFilterBtn('team', esc(teamRaw), teamRaw)}</td>
    <td class="txn-filterable${agentExcl}">${esc(resolveAgentName(t.agent_id))}${txnFilterBtn('agent', t.agent_id, t.agent_id)}</td>
    <td class="txn-filterable${toolExcl}">${esc(resolveToolName(t.tool_id))}${txnFilterBtn('tool', t.tool_id, t.tool_id)}</td>
    <td>${esc(t.method)}</td>
    <td class="mono" style="font-size:12px">${esc(t.path || '')}</td>
    <td>${t.latency_ms}ms</td>
    <td>$${(t.cost || 0).toFixed(4)}</td>
  </tr>`;
  }).join('');
  const rangeEnd = txnOffset + txnAll.length;
  const displayTotal = txnTotal > 0 ? txnTotal : rangeEnd;
  pag.style.display = 'flex';
  document.getElementById('txn-page-info').textContent = txnAll.length ? `${txnOffset + 1}–${rangeEnd} of ${displayTotal}` : 'No results';
  document.getElementById('txn-prev').disabled = txnOffset <= 0;
  document.getElementById('txn-next').disabled = !txnNextCursor;
}

// --- Usage ---
function viewTeamUsage(teamName) {
  usageAgentIds = [];
  usageToolIds = [];
  usageTeamFilters = [teamName];
  syncDropdowns();
  renderFilterPills();
  navigateTo('usage');
  loadUsage();
}

function viewAgentUsage(agentId, agentName) {
  usageToolIds = [];
  usageTeamFilters = [];
  usageAgentIds = [agentId];
  syncDropdowns();
  renderFilterPills();
  navigateTo('usage');
  loadUsage();
}

function onAgentFilterChange() {}
function onTeamFilterChange() {}

function populateAgentFilter() {
  const options = agentsCache.map(a => ({ value: a.id, label: a.name }));
  msRender('usage-agent-select', options, usageAgentIds, resolveAgentName, val => {
    const idx = usageAgentIds.indexOf(val);
    if (idx >= 0) usageAgentIds.splice(idx, 1); else usageAgentIds.push(val);
    syncDropdowns();
    renderFilterPills();
    renderTxnTable();
    renderUsageChart(lastChartTxns);
    loadUsage();
  }, () => {
    usageAgentIds = [];
    syncDropdowns(); renderFilterPills(); renderTxnTable(); renderUsageChart(lastChartTxns); loadUsage();
  });
}

function viewToolUsage(toolId, toolName) {
  usageAgentIds = [];
  usageTeamFilters = [];
  usageToolIds = [toolId];
  syncDropdowns();
  renderFilterPills();
  navigateTo('usage');
  loadUsage();
}

function onToolFilterChange() {}

function populateToolFilter() {
  const options = toolsCache.map(t => ({ value: t.id, label: t.name }));
  msRender('usage-tool-select', options, usageToolIds, resolveToolName, val => {
    const idx = usageToolIds.indexOf(val);
    if (idx >= 0) usageToolIds.splice(idx, 1); else usageToolIds.push(val);
    syncDropdowns();
    renderFilterPills();
    renderTxnTable();
    renderUsageChart(lastChartTxns);
    loadUsage();
  }, () => {
    usageToolIds = [];
    syncDropdowns(); renderFilterPills(); renderTxnTable(); renderUsageChart(lastChartTxns); loadUsage();
  });
}

async function loadUsage() {
  if (!currentUser) return;
  if (usageMode === 'live') { loadUsageLive(); return; }
  showUsageLoading();
  const from = document.getElementById('usage-from').value;
  const to = document.getElementById('usage-to').value;
  let qs = '';
  if (from) qs += '&from=' + from;
  if (to) qs += '&to=' + to;

  let baseTxnPrefix, usagePath, txnQs;
  if (isAdmin) {
    usagePath = '/api/v1/admin/usage';
    baseTxnPrefix = '/api/v1/admin/usage/transactions?';
    txnQs = qs;
    if (usageTeamFilters.length > 0) {
      const teamParam = '&team=' + encodeURIComponent(usageTeamFilters.join(','));
      qs += teamParam;
      txnQs += teamParam;
    }
    if (usageAgentIds.length > 0) {
      const agentParam = '&agent_id=' + encodeURIComponent(usageAgentIds.join(','));
      qs += agentParam;
      txnQs += agentParam;
    }
    if (usageToolIds.length > 0) {
      const toolParam = '&tool_id=' + encodeURIComponent(usageToolIds.join(','));
      qs += toolParam;
      txnQs += toolParam;
    }
  } else {
    usagePath = '/api/v1/member/usage';
    baseTxnPrefix = '/api/v1/member/usage/transactions?';
    txnQs = qs;
    if (usageTeamFilters.length > 0) {
      txnQs += '&team=' + encodeURIComponent(usageTeamFilters.join(','));
    }
    if (usageToolIds.length > 0) {
      txnQs += '&tool_id=' + encodeURIComponent(usageToolIds.join(','));
    }
  }

  txnBasePath = baseTxnPrefix + 'limit=' + txnPageSize + txnQs;
  try {
    const [summary, tableResp, chartTxns] = await Promise.all([
      api('GET', usagePath + '?' + qs),
      api('GET', txnBasePath),
      api('GET', baseTxnPrefix + 'limit=5000' + txnQs),
    ]);
    renderUsageSummary(summary);
    txnTotal = summary.total_requests || 0;
    txnAll = tableResp.transactions || [];
    txnNextCursor = tableResp.next_cursor || null;
    txnCursorStack = [];
    txnOffset = 0;
    renderUsageChart((chartTxns.transactions || chartTxns) || txnAll);
    renderTxnTable();
  } catch (e) { console.error('Failed to load usage', e); hideUsageLoading(); }
}

function showUsageLoading() {
  usageLoading = true;
  ['stat-requests','stat-cost','stat-latency'].forEach(id => {
    document.getElementById(id).innerHTML = '<span class="usage-spinner"></span>';
  });
  document.getElementById('txn-empty').style.display = 'none';
  document.getElementById('txn-body').innerHTML = '<tr><td colspan="8"><div class="usage-spinner"></div></td></tr>';
  document.getElementById('usage-chart').innerHTML = '<div class="usage-spinner"></div>';
}

function hideUsageLoading() { usageLoading = false; }

function renderUsageSummary(summary) {
  hideUsageLoading();
  document.getElementById('stat-requests').textContent = summary.total_requests ?? 0;
  document.getElementById('stat-cost').textContent = '$' + (summary.total_cost ?? 0).toFixed(4);
  document.getElementById('stat-latency').textContent = (summary.avg_latency_ms ?? 0).toFixed(1) + 'ms';
}

async function txnPrevPage() {
  if (txnCursorStack.length === 0) return;
  txnCursorStack.pop(); // remove current page's cursor
  const prevCursor = txnCursorStack.length > 0 ? txnCursorStack[txnCursorStack.length - 1] : null;
  let url = txnBasePath;
  if (prevCursor) url += '&cursor=' + encodeURIComponent(prevCursor);
  try {
    const resp = await api('GET', url);
    txnAll = resp.transactions || [];
    txnNextCursor = resp.next_cursor || null;
    txnOffset = Math.max(0, txnOffset - txnPageSize);
    renderTxnTable();
  } catch (e) { console.error('Failed to load prev page', e); }
}
async function txnNextPage() {
  if (!txnNextCursor) return;
  txnCursorStack.push(txnNextCursor);
  try {
    const resp = await api('GET', txnBasePath + '&cursor=' + encodeURIComponent(txnNextCursor));
    txnAll = resp.transactions || [];
    txnNextCursor = resp.next_cursor || null;
    txnOffset += txnPageSize;
    renderTxnTable();
  } catch (e) { console.error('Failed to load next page', e); }
}

// --- Users ---
async function loadUsers() {
  if (!currentUser) return;
  try {
    const path = isAdmin ? '/api/v1/admin/users' : '/api/v1/member/users';
    const data = await api('GET', path);
    usersCache = data.users || [];
    // Sort current user to top.
    if (currentUser) {
      usersCache.sort((a, b) => {
        if (a.id === currentUser.id) return -1;
        if (b.id === currentUser.id) return 1;
        return 0;
      });
    }
    renderUsers();
  } catch (e) { console.error('Failed to load users', e); }
}

function renderUsers() {
  const tbody = document.getElementById('users-body');
  const empty = document.getElementById('users-empty');
  const q = (document.getElementById('users-search').value || '').toLowerCase();
  const filtered = usersCache.filter(u => !q || u.email.toLowerCase().includes(q) || (u.name || '').toLowerCase().includes(q) || (u.role || '').toLowerCase().includes(q));
  if (!filtered.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = filtered.map(u => {
    const teamsStr = (u.teams && u.teams.length)
      ? u.teams.map(t => t.team + ':' + t.role).join(', ')
      : '\u2014';
    const roleLabel = u.role === 'org_admin' ? 'org admin' : u.role;
    const isSelf = currentUser && u.id === currentUser.id;
    const canEdit = isAdmin || isSelf;
    const canDelete = isAdmin && !isSelf;
    const editAttr = canEdit ? '' : ' disabled title="You can only edit your own profile"';
    const deleteAttr = canDelete ? '' : (isSelf ? ' disabled title="Cannot delete yourself"' : ' disabled title="Org admin only"');
    return `<tr${isSelf ? ' style="background:var(--surface)"' : ''}>
    <td style="font-weight:600">${esc(u.email)}${isSelf ? ' <span style="font-size:9px;color:var(--text2)">(you)</span>' : ''}</td>
    <td>${esc(u.name || '\u2014')}</td>
    <td>${esc(teamsStr)}</td>
    <td><span class="role-badge${u.role === 'org_admin' ? ' admin' : ''}">${esc(roleLabel)}</span></td>
    <td>${fmtDate(u.created_at)}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editUser('${u.id}')"${editAttr}>Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteUser('${u.id}','${esc(u.email)}')"${deleteAttr}>Delete</button>
    </td>
  </tr>`;
  }).join('');
}

function openUserModal(u) {
  const isSelfEdit = u && currentUser && u.id === currentUser.id && !isAdmin;
  document.getElementById('user-edit-id').value = u ? u.id : '';
  document.getElementById('user-modal-title').textContent = u ? 'Edit User' : 'Create User';
  document.getElementById('user-submit-btn').textContent = u ? 'Save' : 'Create';
  document.getElementById('user-email').value = u ? u.email : '';
  document.getElementById('user-email').disabled = isSelfEdit;
  document.getElementById('user-password').value = '';
  document.getElementById('user-name-input').value = u ? u.name || '' : '';
  document.getElementById('user-role').value = u ? u.role || 'member' : 'member';
  document.getElementById('user-role').disabled = isSelfEdit;
  // Password fields: admin edit uses inline password field, self-edit uses change password section
  const pwGroup = document.getElementById('user-password-group');
  const changePwGroup = document.getElementById('user-change-password-group');
  if (isSelfEdit) {
    pwGroup.style.display = 'none';
    changePwGroup.style.display = '';
    document.getElementById('user-current-password').value = '';
    document.getElementById('user-new-password').value = '';
  } else {
    pwGroup.style.display = '';
    changePwGroup.style.display = 'none';
    pwGroup.querySelector('label').textContent = u ? 'Password (leave blank to keep)' : 'Password *';
  }
  document.getElementById('user-modal').classList.add('open');
}

function editUser(id) {
  const u = usersCache.find(u => u.id === id);
  if (u) openUserModal(u);
}

async function submitUser() {
  const id = document.getElementById('user-edit-id').value;
  const email = document.getElementById('user-email').value.trim();
  const password = document.getElementById('user-password').value;
  const name = document.getElementById('user-name-input').value.trim();
  const role = document.getElementById('user-role').value;

  if (id) {
    const isSelf = currentUser && id === currentUser.id;
    if (!isAdmin && isSelf) {
      // Member self-edit: name via /users/me, password via /users/me/password.
      try {
        const body = {};
        if (name !== undefined) body.name = name;
        await api('PUT', '/api/v1/member/users/me', body);
        // Handle password change separately if fields are filled.
        const currentPw = document.getElementById('user-current-password').value;
        const newPw = document.getElementById('user-new-password').value;
        if (currentPw && newPw) {
          if (newPw.length < 6) { toast('New password must be at least 6 characters'); return; }
          await api('PUT', '/api/v1/member/users/me/password', { current_password: currentPw, new_password: newPw });
          toast('Password changed');
        }
        closeModal('user-modal');
        if (body.name !== undefined) {
          currentUser.name = body.name;
          document.querySelector('.user-name').textContent = currentUser.name || currentUser.email;
          saveSession();
        }
        loadUsers();
      } catch (e) { toast('Error: ' + e.message); }
    } else {
      const body = {};
      if (email) body.email = email;
      if (password) body.password = password;
      if (name !== undefined) body.name = name;
      if (role) body.role = role;
      try {
        await api('PUT', '/api/v1/admin/users/' + id, body);
        closeModal('user-modal');
        loadUsers();
      } catch (e) { toast('Error: ' + e.message); }
    }
  } else {
    if (!email || !password) { toast('Email and password are required'); return; }
    const body = { email, password, name, role };
    try {
      await api('POST', '/api/v1/admin/users', body);
      closeModal('user-modal');
      loadUsers();
    } catch (e) { toast('Error: ' + e.message); }
  }
}

async function deleteUser(id, email) {
  if (!await appConfirm('Delete user "' + email + '"?')) return;
  try {
    await api('DELETE', '/api/v1/admin/users/' + id);
    loadUsers();
  } catch (e) { toast('Error: ' + e.message); }
}

// --- Helpers ---
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtDate(s) { if (!s) return '\u2014'; return new Date(s).toLocaleDateString(); }
function fmtTime(s) { if (!s) return '\u2014'; const d = new Date(s); return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); }
function resolveAgentName(id) { const a = agentsCache.find(a => a.id === id); return a ? a.name : id.slice(0,8); }
function resolveAgentTeam(id) { const a = agentsCache.find(a => a.id === id); return a ? (a.team || '') : ''; }
function resolveToolName(id) { const t = toolsCache.find(t => t.id === id); return t ? t.name : id.slice(0,8); }

function filterFromTxn(type, value, event) {
  if (shiftHeld && value) {
    // Shift held: toggle in pending set, don't reload yet.
    const setKey = type === 'team' ? 'teams' : type === 'agent' ? 'agents' : 'tools';
    if (pendingFilters[setKey].has(value)) {
      pendingFilters[setKey].delete(value);
    } else {
      pendingFilters[setKey].add(value);
    }
    // Re-render table and chart to reflect pending strikethrough state.
    renderTxnTable();
    renderUsageChart(lastChartTxns);
    return;
  }
  // No shift: single-select toggle (clear all others, set this one or clear if already active).
  if (type === 'team') {
    if (!value || (usageTeamFilters.length === 1 && usageTeamFilters[0] === value)) {
      usageTeamFilters = [];
    } else {
      usageTeamFilters = [value];
    }
  } else if (type === 'agent') {
    if (!value || (usageAgentIds.length === 1 && usageAgentIds[0] === value)) {
      usageAgentIds = [];
    } else {
      usageAgentIds = [value];
    }
  } else if (type === 'tool') {
    if (!value || (usageToolIds.length === 1 && usageToolIds[0] === value)) {
      usageToolIds = [];
    } else {
      usageToolIds = [value];
    }
  }
  syncDropdowns();
  renderFilterPills();
  chartLegendHover = false;
  document.body.classList.remove('chart-paused');
  renderTxnTable();
  renderUsageChart(lastChartTxns);
  loadUsage();
}

// Remove a single item from the active filter (used by the × icon on active rows).
function removeFilterItem(type, value, event) {
  if (shiftHeld) {
    // During shift, treat as a pending toggle (same as filterFromTxn shift path).
    filterFromTxn(type, value, event);
    return;
  }
  if (type === 'team') usageTeamFilters = usageTeamFilters.filter(t => t !== value);
  else if (type === 'agent') usageAgentIds = usageAgentIds.filter(a => a !== value);
  else if (type === 'tool') usageToolIds = usageToolIds.filter(t => t !== value);
  syncDropdowns();
  renderFilterPills();
  loadUsage();
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

document.addEventListener('click', () => {
  document.querySelectorAll('.multi-select.open').forEach(ms => ms.classList.remove('open'));
});

// Set default date range to last 7 days
const now = new Date();
const tomorrow = new Date(now);
tomorrow.setDate(tomorrow.getDate() + 1);
const weekAgo = new Date(now);
weekAgo.setDate(weekAgo.getDate() - 7);
document.getElementById('usage-to').value = tomorrow.toISOString().slice(0, 10);
document.getElementById('usage-from').value = weekAgo.toISOString().slice(0, 10);

// --- Chart ---
let chartGroup = 'agent';
let lastChartTxns = [];
const chartColors = ['#1a1a1a','#2a7','#a80','#c33','#57a','#7a5','#a57','#5a7'];
function chartColorFor(id) {
  let h = 0;
  for (let i = 0; i < id.length; i++) h = ((h << 5) - h + id.charCodeAt(i)) | 0;
  return chartColors[((h % chartColors.length) + chartColors.length) % chartColors.length];
}

// Restore persisted selections
document.getElementById('usage-lookback-select').value = String(liveLookback);

function onBucketChange() {
  // User manually picked a bucket — just re-render with current selection.
  renderUsageChart(lastChartTxns);
}

function onLookbackChange() {
  liveLookback = parseInt(document.getElementById('usage-lookback-select').value);
  localStorage.setItem('octroi_live_lookback', String(liveLookback));
  lastAutoRange = 0; // reset so bucket auto-syncs to new window
  lastTxnTimestamp = null;
  loadUsage();
}

function setChartGroup(group) {
  chartGroup = group;
  document.getElementById('chart-by-agent').classList.toggle('active', group === 'agent');
  document.getElementById('chart-by-tool').classList.toggle('active', group === 'tool');
  renderUsageChart(lastChartTxns);
}

function autoBucketMs(range) {
  if (range <= 600000) return 30000;          // <=10min -> 30s
  if (range <= 3600000) return 300000;        // <=1h -> 5min
  if (range <= 86400000) return 3600000;      // <=1d -> 1h
  return 86400000;                             // >1d -> 1 day
}

function pickBucketMs(range) {
  return parseInt(document.getElementById('usage-bucket-select').value);
}

let lastAutoRange = 0;
function syncBucketSelect(range) {
  const best = String(autoBucketMs(range));
  const bestForLast = String(autoBucketMs(lastAutoRange));
  const sel = document.getElementById('usage-bucket-select');
  // Auto-update bucket when the ideal bucket for the range changes,
  // or on first render (lastAutoRange === 0).
  if (lastAutoRange === 0 || best !== bestForLast) {
    sel.value = best;
  }
  lastAutoRange = range;
}

function fmtBucketLabel(d, bucketMs) {
  if (bucketMs >= 86400000) return (d.getMonth()+1) + '/' + d.getDate();
  if (bucketMs <= 60000) return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function renderUsageChart(txns) {
  lastChartTxns = txns;
  const container = document.getElementById('usage-chart');
  if (!txns || !txns.length) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:180px;color:var(--text2);font-size:12px">No data</div>';
    return;
  }

  const rect = container.getBoundingClientRect();
  const W = rect.width || 600;
  const H = 180;
  const ML = 34, MR = 8, MT = 8, MB = 44;
  const chartW = W - ML - MR;
  const chartH = H - MT - MB;

  const now = Date.now();
  const tMin = usageMode === 'live' ? now - liveLookback : Math.min(...txns.map(t => new Date(t.timestamp).getTime()));
  const tMax = usageMode === 'live' ? now : Math.max(...txns.map(t => new Date(t.timestamp).getTime()));
  const range = Math.max(tMax - tMin, 1);

  syncBucketSelect(range);
  const bucketMs = pickBucketMs(range);

  const bucketStart = Math.floor(tMin / bucketMs) * bucketMs;
  const bucketEnd = Math.floor(tMax / bucketMs) * bucketMs + bucketMs;
  const numBuckets = Math.max(1, Math.round((bucketEnd - bucketStart) / bucketMs));

  const groupKey = chartGroup === 'agent' ? 'agent_id' : 'tool_id';
  const resolveName = chartGroup === 'agent' ? resolveAgentName : resolveToolName;

  // Bucket transactions
  const buckets = [];
  const groupSet = new Set();
  for (let i = 0; i < numBuckets; i++) buckets.push({});

  txns.forEach(t => {
    const ts = new Date(t.timestamp).getTime();
    const bi = Math.min(Math.floor((ts - bucketStart) / bucketMs), numBuckets - 1);
    if (bi < 0) return;
    const gid = t[groupKey];
    groupSet.add(gid);
    buckets[bi][gid] = (buckets[bi][gid] || 0) + 1;
  });

  const groups = Array.from(groupSet).sort((a, b) => resolveName(a).localeCompare(resolveName(b)));
  const maxCount = Math.max(1, ...buckets.map(b => Math.max(0, ...groups.map(g => b[g] || 0))));

  const yStep = Math.max(1, Math.ceil(maxCount / 4));
  const yMax = yStep * 4;
  const yTicks = [];
  for (let v = 0; v <= yMax; v += yStep) yTicks.push(v);

  // Build SVG
  let svg = `<svg width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg" style="font-family:var(--font)">`;

  // Y gridlines + labels
  yTicks.forEach(v => {
    const y = MT + chartH - (v / yMax) * chartH;
    svg += `<line x1="${ML}" y1="${y}" x2="${W - MR}" y2="${y}" class="chart-tick"/>`;
    svg += `<text x="${ML - 4}" y="${y + 3}" text-anchor="end" class="chart-label">${v}</text>`;
  });

  // Line chart
  const colW = chartW / Math.max(1, numBuckets - 1);
  const xFor = i => numBuckets === 1 ? ML + chartW / 2 : ML + i * colW;
  const yFor = v => MT + chartH - (v / yMax) * chartH;

  groups.forEach(gid => {
    const color = chartColorFor(gid);
    const points = [];
    for (let i = 0; i < numBuckets; i++) {
      points.push(`${xFor(i)},${yFor(buckets[i][gid] || 0)}`);
    }
    svg += `<polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" data-group="${gid}" class="chart-line"/>`;
    for (let i = 0; i < numBuckets; i++) {
      const count = buckets[i][gid] || 0;
      if (count > 0) {
        svg += `<circle cx="${xFor(i)}" cy="${yFor(count)}" r="2.5" fill="${color}" data-group="${gid}" class="chart-line"/>`;
      }
    }
  });

  // Invisible hover zones
  for (let i = 0; i < numBuckets; i++) {
    const zoneW = numBuckets === 1 ? chartW : colW;
    const zoneX = numBuckets === 1 ? ML : ML + i * colW - colW / 2;
    svg += `<rect x="${Math.max(ML, zoneX)}" y="${MT}" width="${Math.min(zoneW, W - MR - Math.max(ML, zoneX))}" height="${chartH}" fill="transparent" data-bucket="${i}" class="chart-hover-zone"/>`;
  }

  // X-axis labels
  const labelEvery = Math.max(1, Math.ceil(numBuckets / 8));
  for (let i = 0; i < numBuckets; i += labelEvery) {
    const x = xFor(i);
    const d = new Date(bucketStart + i * bucketMs);
    svg += `<text x="${x}" y="${H - MB + 14}" text-anchor="middle" class="chart-label">${fmtBucketLabel(d, bucketMs)}</text>`;
  }

  svg += '</svg>';

  // Legend
  const eff = effectiveFilters();
  const filterType = chartGroup === 'agent' ? 'agent' : 'tool';
  const activeFilterArr = filterType === 'agent' ? eff.agents : eff.tools;
  const hasLegendFilter = activeFilterArr.length > 0;
  let legend = '<div class="chart-legend">';
  groups.forEach((gid, gi) => {
    const color = chartColorFor(gid);
    const name = resolveName(gid);
    const isActive = activeFilterArr.includes(gid);
    const filterVal = isActive ? '' : gid;
    const exclClass = hasLegendFilter && !isActive ? ' chart-legend-excluded' : '';
    legend += `<div class="chart-legend-item${exclClass}" data-group="${gid}" onclick="filterFromTxn('${filterType}','${filterVal}')" style="cursor:pointer"><span class="chart-legend-swatch" style="background:${color}${hasLegendFilter && !isActive ? ';opacity:0.3' : ''}"></span>${esc(name)}</div>`;
  });
  legend += '</div>';

  // Tooltip
  const tooltipHtml = '<div class="chart-tooltip" id="chart-tooltip" style="display:none"></div>';

  container.innerHTML = tooltipHtml + svg + legend;

  // Attach hover events
  const tooltip = document.getElementById('chart-tooltip');

  container.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

  container.querySelectorAll('.chart-hover-zone').forEach(zone => {
    zone.addEventListener('mouseenter', () => {
      const bi = parseInt(zone.dataset.bucket);
      const d = new Date(bucketStart + bi * bucketMs);
      let html = `<div class="tt-time">${fmtBucketLabel(d, bucketMs)}</div>`;
      let total = 0;
      groups.forEach((gid, gi) => {
        const count = buckets[bi][gid] || 0;
        total += count;
        const color = chartColorFor(gid);
        const name = resolveName(gid);
        html += `<div class="tt-row"><span class="tt-swatch" style="background:${color}"></span>${esc(name)}: <strong>${count}</strong></div>`;
      });
      if (groups.length > 1) {
        html += `<div class="tt-row" style="border-top:1px solid var(--border);margin-top:2px;padding-top:2px">Total: <strong>${total}</strong></div>`;
      }
      tooltip.innerHTML = html;
      tooltip.style.display = '';

      // Position tooltip near the hovered bar
      const barCenterX = xFor(bi);
      const ttW = tooltip.offsetWidth;
      const containerW = container.getBoundingClientRect().width;
      let left = barCenterX + 12;
      if (left + ttW > containerW - 4) left = barCenterX - ttW - 12;
      tooltip.style.left = left + 'px';
      tooltip.style.top = MT + 'px';
    });
  });

  // Legend hover: fade other lines
  container.querySelectorAll('.chart-legend-item').forEach(item => {
    item.addEventListener('mouseenter', () => {
      chartLegendHover = true;
      document.body.classList.add('chart-paused');
      const gid = item.dataset.group;
      container.querySelectorAll('.chart-line').forEach(el => {
        el.style.opacity = el.dataset.group === gid ? '1' : '0.1';
      });
      container.querySelectorAll('.chart-legend-item').forEach(li => {
        li.style.opacity = li.dataset.group === gid ? '1' : '0.3';
      });
    });
    item.addEventListener('mouseleave', () => {
      chartLegendHover = false;
      document.body.classList.remove('chart-paused');
      container.querySelectorAll('.chart-line').forEach(el => { el.style.opacity = ''; });
      container.querySelectorAll('.chart-legend-item').forEach(li => { li.style.opacity = ''; });
    });
  });
}

// --- Metrics ---
let metricsPollTimer = null;

function startMetricsPoll() {
  stopMetricsPoll();
  metricsPollTimer = setTimeout(function tick() {
    fetch('/api/v1/admin/metrics', {
      headers: { 'Authorization': 'Bearer ' + authToken },
      cache: 'no-store',
    })
      .then(function(r) { return r.ok ? r.json() : Promise.reject(r.statusText); })
      .then(function(data) { renderMetricsLive(data); })
      .catch(function() {
        document.getElementById('metrics-cards').innerHTML = '<div class="empty">Failed to load metrics.</div>';
      })
      .finally(function() {
        metricsPollTimer = setTimeout(tick, 1000);
      });
  }, 1500);
}

function stopMetricsPoll() {
  if (metricsPollTimer) { clearTimeout(metricsPollTimer); metricsPollTimer = null; }
}

function loadMetrics() {
  if (!currentUser) return;
  fetch('/api/v1/admin/metrics', {
    headers: { 'Authorization': 'Bearer ' + authToken },
    cache: 'no-store',
  })
    .then(function(r) { return r.ok ? r.json() : Promise.reject(r.statusText); })
    .then(function(data) { renderMetricsLive(data); })
    .catch(function() {
      document.getElementById('metrics-cards').innerHTML = '<div class="empty">Failed to load metrics.</div>';
    });
}

function renderMetricsLive(d) {
  const sections = [
    { title: 'Inbound (Agent \u2192 Octroi)', tip: 'HTTP requests from agents hitting the /proxy endpoint', cards: [
      { label: 'Total Requests', value: fmtNum(d.http.totalRequests), tip: 'Total proxy HTTP requests from agents since startup' },
      { label: 'Error Rate', value: d.http.errorRate.toFixed(2) + '%', tip: 'Percentage of proxy requests that returned 4xx/5xx' },
      { label: 'P50 Latency', value: fmtMs(d.http.p50Latency), tip: '50th percentile proxy request duration' },
      { label: 'P95 Latency', value: fmtMs(d.http.p95Latency), tip: '95th percentile proxy request duration' },
      { label: 'P99 Latency', value: fmtMs(d.http.p99Latency), tip: '99th percentile proxy request duration' },
    ]},
    { title: 'Management', tip: 'Non-proxy HTTP traffic: admin UI, API calls, metrics scrapes, login', cards: [
      { label: 'Total Requests', value: fmtNum((d.management||{}).totalRequests), tip: 'Total management HTTP requests (UI, API, metrics) since startup' },
      { label: 'Error Rate', value: ((d.management||{}).errorRate||0).toFixed(2) + '%', tip: 'Percentage of management requests that returned 4xx/5xx' },
      { label: 'P50 Latency', value: fmtMs((d.management||{}).p50Latency), tip: '50th percentile management request duration' },
      { label: 'P95 Latency', value: fmtMs((d.management||{}).p95Latency), tip: '95th percentile management request duration' },
    ]},
    { title: 'Upstream (Octroi \u2192 Tool)', tip: 'Requests forwarded from Octroi to upstream tool endpoints', cards: [
      { label: 'Requests', value: fmtNum(d.proxy.totalRequests), tip: 'Total requests proxied to upstream tool endpoints' },
      { label: 'Errors', value: fmtNum((d.server||{}).upstreamErrors), tip: 'Proxy requests that failed to reach the upstream tool (timeouts, DNS, connection errors)' },
      { label: 'P50 Latency', value: fmtMs(d.proxy.p50Upstream), tip: '50th percentile upstream tool response time' },
      { label: 'P95 Latency', value: fmtMs(d.proxy.p95Upstream), tip: '95th percentile upstream tool response time' },
      { label: 'Active', value: fmtNum(d.proxy.activeRequests), tip: 'Requests currently in-flight to upstream tools' },
    ]},
    { title: 'Security', tip: 'Rate limiting, budget enforcement, and authentication events', cards: [
      { label: 'Rate Limit Rejects', value: fmtNum(d.rateLimit.rejections), tip: 'Requests rejected due to agent or tool rate limits (HTTP 429)' },
      { label: 'Budget Rejects', value: fmtNum(d.budget.rejections), tip: 'Requests rejected due to agent or global tool budget limits' },
      { label: 'Auth Failures', value: fmtNum(d.auth.failures), tip: 'Failed authentication attempts (invalid API keys or sessions)' },
      { label: 'Auth Successes', value: fmtNum(d.auth.successes), tip: 'Successful authentication attempts (agent keys and user sessions)' },
    ]},
    { title: 'Collector', tip: 'Metering collector that buffers and flushes usage data to the database', cards: [
      { label: 'Buffer Size', value: fmtNum(d.collector.bufferSize), tip: 'Metering transactions buffered in memory awaiting flush to database' },
      { label: 'Total Flushes', value: fmtNum(d.collector.totalFlushes), tip: 'Total metering collector flush operations (both successful and failed)' },
      { label: 'Flush Errors', value: fmtNum(d.collector.flushErrors), tip: 'Metering collector flushes that failed to write to the database' },
      { label: 'Transactions', value: fmtNum(d.collector.transactions), tip: 'Total metering transactions recorded (proxy calls tracked for billing/usage)' },
    ]},
    { title: 'System', tip: 'Server uptime and PostgreSQL connection pool status', cards: [
      { label: 'Uptime', value: fmtUptime((d.server||{}).uptimeSeconds), tip: 'Time since the Octroi server process started' },
      { label: 'DB Total Conns', value: fmtNum(d.db.totalConns), tip: 'Total connections in the PostgreSQL connection pool' },
      { label: 'DB Idle Conns', value: fmtNum(d.db.idleConns), tip: 'Idle (available) connections in the database pool' },
      { label: 'DB Acquired', value: fmtNum(d.db.acquiredConns), tip: 'Database connections currently in use by active queries' },
    ]},
  ];
  renderMetricsSections(sections);
}

function renderMetricsSections(sections) {
  document.getElementById('metrics-cards').innerHTML = sections.map(s =>
    '<div class="metrics-section"><div class="metrics-section-title has-tooltip">' + esc(s.title) + (s.tip ? '<span class="tip">' + esc(s.tip) + '</span>' : '') + '</div><div class="cards">' +
    s.cards.map(c =>
      '<div class="card has-tooltip"><span class="tip">' + esc(c.tip) + '</span><div class="label">' + esc(c.label) + '</div><div class="value">' + esc(c.value) + '</div></div>'
    ).join('') + '</div></div>'
  ).join('');
}

function fmtNum(n) { return n == null ? '0' : Number(n).toLocaleString(); }
function fmtMs(s) { return s == null || s === 0 ? '0ms' : s < 1 ? (s * 1000).toFixed(1) + 'ms' : s.toFixed(3) + 's'; }
function fmtUptime(s) {
  if (s == null || s <= 0) return '0s';
  var d = Math.floor(s / 86400), h = Math.floor((s % 86400) / 3600), m = Math.floor((s % 3600) / 60), sec = Math.floor(s % 60);
  if (d > 0) return d + 'd ' + h + 'h ' + m + 'm ' + sec + 's';
  if (h > 0) return h + 'h ' + m + 'm ' + sec + 's';
  if (m > 0) return m + 'm ' + sec + 's';
  return sec + 's';
}
</script>
</body>
</html>
