<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Octroi Admin</title>
<style>
:root {
  --bg: #ffffff;
  --surface: #f5f5f0;
  --surface2: #eaeae5;
  --border: #d0d0c8;
  --text: #1a1a1a;
  --text2: #707068;
  --accent: #1a1a1a;
  --accent-hover: #444;
  --danger: #c33;
  --danger-hover: #e44;
  --success: #2a7;
  --warn: #a80;
  --font: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 12px;
  line-height: 1.5;
}
/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar h1 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.topbar .spacer { flex: 1; }
.user-info { display: flex; align-items: center; gap: 8px; font-size: 11px; }
.user-info .user-name { font-weight: 600; }
.role-badge {
  display: inline-block;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1px 5px;
  border: 1px solid var(--border);
  color: var(--text2);
}
.role-badge.admin { border-color: var(--warn); color: var(--warn); }
/* Buttons */
button {
  font-family: var(--font);
  cursor: pointer;
  border: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  padding: 4px 10px;
  background: var(--bg);
  color: var(--text);
  transition: background 0.1s;
}
button:hover:not(:disabled) { background: var(--surface2); }
button:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn-danger { background: var(--bg); color: var(--danger); border-color: var(--danger); }
.btn-danger:hover:not(:disabled) { background: #fef0f0; }
.btn-ghost { background: transparent; color: var(--text2); }
.btn-ghost:hover:not(:disabled) { color: var(--text); background: var(--surface); }
.btn-sm { padding: 2px 8px; font-size: 11px; }
.btn-warn { background: var(--bg); color: var(--warn); border-color: var(--warn); }
.btn-warn:hover:not(:disabled) { background: #fef8f0; }
/* Tabs */
.tabs {
  display: flex;
  gap: 0;
  padding: 0 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.tab-btn {
  background: none;
  color: var(--text2);
  border: none;
  border-bottom: 2px solid transparent;
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.tab-btn:hover { color: var(--text); background: none; }
.tab-btn.active { color: var(--text); border-bottom-color: var(--text); font-weight: 700; }
/* Content */
.content { padding: 16px; max-width: 1200px; margin: 0 auto; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
th:last-child, td:last-child { width: 120px; text-align: right; }
thead th {
  text-align: left;
  padding: 6px 8px;
  color: var(--text2);
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  border-bottom: 2px solid var(--border);
}
tbody td {
  padding: 5px 8px;
  border-bottom: 1px solid var(--surface2);
  vertical-align: top;
}
tbody tr:hover { background: var(--surface); }
.mono { font-family: var(--font); font-size: 12px; }
/* Cards */
.cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 12px;
}
.card .label { font-size: 10px; color: var(--text2); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
.card .value { font-size: 20px; font-weight: 700; }
/* Toolbar */
.toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
.toolbar h2, .toolbar-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 200;
  justify-content: center;
  align-items: flex-start;
  padding: 60px 24px;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg);
  border: 1px solid var(--border);
  width: 100%;
  max-width: 520px;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 16px;
}
.modal h3 { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.form-group { margin-bottom: 10px; }
.form-group label {
  display: block;
  font-size: 10px;
  color: var(--text2);
  margin-bottom: 3px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 8px;
  font-size: 12px;
  font-family: var(--font);
}
.form-group textarea { min-height: 50px; resize: vertical; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  outline: none;
  border-color: var(--text);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 14px; }
/* Banner */
.banner {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--success);
  padding: 8px 12px;
  margin-bottom: 12px;
  font-size: 12px;
  display: none;
}
.banner.show { display: block; }
.banner .key-value { font-weight: 700; color: var(--text); user-select: all; }
/* Filters */
.filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.filters input[type="date"], .filters select {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 4px 8px;
  font-size: 12px;
  font-family: var(--font);
}
/* Empty state */
.empty { text-align: center; padding: 32px; color: var(--text2); font-size: 12px; }
/* Login screen */
#login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80vh;
}
.login-box {
  width: 320px;
  border: 1px solid var(--border);
  padding: 24px;
  background: var(--surface);
}
.login-box h2 {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  text-align: center;
}
.login-error {
  color: var(--danger);
  font-size: 11px;
  margin-bottom: 8px;
  display: none;
}
/* Links */
a { color: var(--text); }
a:hover { color: var(--text2); }
/* Usage mode toggle */
.usage-mode-toggle { display: flex; gap: 0; margin-left: 12px; }
.mode-btn {
  background: var(--bg);
  border: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  padding: 3px 12px;
  color: var(--text2);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
}
.mode-btn:first-child { border-radius: 3px 0 0 3px; }
.mode-btn:last-child { border-radius: 0 3px 3px 0; border-left: none; }
.mode-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 700; }
.live-dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #2a7;
}
.mode-btn.active .live-dot { background: #5fffaa; animation: pulse 1.5s infinite; }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
@keyframes fadeIn {
  from { background: rgba(42, 119, 77, 0.12); }
  to { background: transparent; }
}
.txn-new { animation: fadeIn 1.2s ease-out; }
/* Team cards */
.team-section {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 12px;
  margin-bottom: 12px;
}
.team-section h3 {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.team-section .team-sub {
  font-size: 10px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 8px 0 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.team-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.team-section li {
  padding: 2px 0;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.team-section li .mono {
  color: var(--text2);
  font-size: 11px;
}

</style>
</head>
<body>
<!-- Top Bar -->
<div class="topbar">
  <h1>octroi</h1>
  <div class="spacer"></div>
  <div class="user-info" id="user-info" style="display:none">
    <span class="user-name" id="topbar-user-name"></span>
    <span class="role-badge" id="topbar-role-badge"></span>
    <button class="btn-ghost btn-sm" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-box">
    <h2>octroi</h2>
    <div class="login-error" id="login-error"></div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="admin@octroi.dev" autocomplete="email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
    </div>
    <div style="margin-top:12px">
      <button class="btn-primary" style="width:100%" id="login-btn" onclick="doLogin()">Connect</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" id="tab-bar" style="display:none">
  <button class="tab-btn active" data-tab="agents">Agents</button>
  <button class="tab-btn" data-tab="tools">Tools</button>
  <button class="tab-btn" data-tab="usage">Usage</button>
  <button class="tab-btn" data-tab="teams">Teams</button>
  <button class="tab-btn" data-tab="users">Users</button>
</div>

<!-- Content -->
<div class="content" id="main-content" style="display:none">
  <!-- Agents Tab -->
  <div class="tab-panel active" id="tab-agents">
    <div class="banner" id="agent-key-banner">
      API key (shown once, copy now): <span class="key-value" id="agent-key-value"></span>
    </div>
    <div style="display:flex;align-items:center;margin-bottom:8px">
      <h2 class="toolbar-title">Agents</h2>
      <div style="flex:1"></div>
      <button class="btn-primary" onclick="openAgentModal()">+ Create Agent</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Team</th>
          <th>Rate Limit</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="agents-body"></tbody>
    </table>
    <div class="empty" id="agents-empty" style="display:none">No agents created yet.</div>
  </div>

  <!-- Tools Tab -->
  <div class="tab-panel" id="tab-tools">
    <div style="display:flex;align-items:center;margin-bottom:8px">
      <h2 class="toolbar-title">Tools</h2>
      <div style="flex:1"></div>
      <button class="btn-primary" id="tools-create-btn" onclick="openToolModal()">+ Create Tool</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th id="tools-endpoint-th">Endpoint</th>
          <th>Auth</th>
          <th>Rate Limit</th>
          <th id="tools-actions-th"></th>
        </tr>
      </thead>
      <tbody id="tools-body"></tbody>
    </table>
    <div class="empty" id="tools-empty" style="display:none">No tools registered yet.</div>
  </div>

  <!-- Teams Tab -->
  <div class="tab-panel" id="tab-teams">
    <div style="display:flex;align-items:center;margin-bottom:8px">
      <h2 class="toolbar-title">Teams</h2>
      <div style="flex:1"></div>
      <button class="btn-primary" id="teams-create-btn" onclick="openCreateTeamModal()">+ Create Team</button>
    </div>
    <div id="teams-content"></div>
    <div class="empty" id="teams-empty" style="display:none">No teams found.</div>
  </div>

  <!-- Usage Tab -->
  <div class="tab-panel" id="tab-usage">
    <div class="toolbar" style="margin-bottom:4px">
      <h2>Usage</h2>
    </div>
    <div class="filters" style="margin-bottom:12px">
      <select id="usage-team-select" onchange="onTeamFilterChange()">
        <option value="">All teams</option>
      </select>
      <select id="usage-agent-select" onchange="onAgentFilterChange()">
        <option value="">All agents</option>
      </select>
      <select id="usage-tool-select" onchange="onToolFilterChange()">
        <option value="">All tools</option>
      </select>
      <div style="flex:1"></div>
      <div id="usage-date-controls" style="display:none;gap:8px;align-items:center">
        <input type="date" id="usage-from">
        <span style="color:var(--text2)">to</span>
        <input type="date" id="usage-to">
        <button class="btn-ghost" onclick="loadUsage()">Apply</button>
      </div>
      <div class="usage-mode-toggle">
        <button class="mode-btn active" id="mode-live" onclick="setUsageMode('live')"><span class="live-dot"></span> Live</button>
        <button class="mode-btn" id="mode-hist" onclick="setUsageMode('historical')">Historical</button>
      </div>
    </div>
    <div class="cards" id="usage-cards">
      <div class="card"><div class="label">Total Requests</div><div class="value" id="stat-requests">&mdash;</div></div>
      <div class="card"><div class="label">Total Cost</div><div class="value" id="stat-cost">&mdash;</div></div>
      <div class="card"><div class="label">Success / Error</div><div class="value" id="stat-results">&mdash;</div></div>
      <div class="card"><div class="label">Avg Latency</div><div class="value" id="stat-latency">&mdash;</div></div>
    </div>
    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px;">Transactions</h3>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Agent</th>
          <th>Tool</th>
          <th>Method</th>
          <th>Status</th>
          <th>Latency</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody id="txn-body"></tbody>
    </table>
    <div class="empty" id="txn-empty" style="display:none">No transactions found.</div>
  </div>

  <!-- Users Tab (org_admin only) -->
  <div class="tab-panel" id="tab-users">
    <div style="display:flex;align-items:center;margin-bottom:8px">
      <h2 class="toolbar-title">Users</h2>
      <div style="flex:1"></div>
      <button class="btn-primary" id="users-create-btn" onclick="openUserModal()">+ Create User</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Teams</th>
          <th>Role</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>
    <div class="empty" id="users-empty" style="display:none">No users created yet.</div>
  </div>
</div>

<!-- Tool Modal -->
<div class="modal-overlay" id="tool-modal">
  <div class="modal">
    <h3 id="tool-modal-title">Create Tool</h3>
    <input type="hidden" id="tool-edit-id">
    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="tool-name" placeholder="e.g. Open Weather Data">
    </div>
    <div class="form-group">
      <label>Description *</label>
      <input type="text" id="tool-description" placeholder="What this tool does">
    </div>
    <div class="form-group">
      <label>Endpoint *</label>
      <input type="url" id="tool-endpoint" placeholder="https://api.example.com/v1">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Auth Type *</label>
        <select id="tool-auth-type">
          <option value="none">none</option>
          <option value="bearer">bearer</option>
          <option value="header">header</option>
          <option value="query">query</option>
        </select>
      </div>
      <div class="form-group">
        <label>Rate Limit (req/min)</label>
        <input type="number" id="tool-rate-limit" placeholder="0">
      </div>
    </div>
    <div class="form-group">
      <label>Auth Config (JSON)</label>
      <textarea id="tool-auth-config" placeholder='{"token": "sk-..."}'></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Pricing Model</label>
        <select id="tool-pricing-model">
          <option value="">none</option>
          <option value="per_request">per_request</option>
          <option value="per_token">per_token</option>
        </select>
      </div>
      <div class="form-group">
        <label>Pricing Amount</label>
        <input type="number" step="any" id="tool-pricing-amount" placeholder="0.00">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Pricing Currency</label>
        <input type="text" id="tool-pricing-currency" placeholder="USD">
      </div>
      <div class="form-group">
        <label>Budget Limit</label>
        <input type="number" step="any" id="tool-budget-limit" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label>Budget Window</label>
      <input type="text" id="tool-budget-window" placeholder="e.g. daily, monthly">
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('tool-modal')">Cancel</button>
      <button class="btn-primary" id="tool-submit-btn" onclick="submitTool()">Create</button>
    </div>
  </div>
</div>

<!-- Agent Modal -->
<div class="modal-overlay" id="agent-modal">
  <div class="modal">
    <h3 id="agent-modal-title">Create Agent</h3>
    <input type="hidden" id="agent-edit-id">
    <div class="form-group" id="agent-key-group" style="display:none">
      <label>Key</label>
      <div class="mono" id="agent-key-display" style="padding:4px 0;color:var(--text2)"></div>
    </div>
    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="agent-name" placeholder="e.g. my-scraper">
    </div>
    <div class="form-row">
      <div class="form-group" id="agent-team-group">
        <label>Team</label>
        <input type="text" id="agent-team" placeholder="e.g. backend">
      </div>
      <div class="form-group">
        <label>Rate Limit (req/min)</label>
        <input type="number" id="agent-rate-limit" placeholder="0">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-warn" id="agent-regen-btn" onclick="regenKeyFromModal()" style="display:none;margin-right:auto">Regenerate Key</button>
      <button class="btn-ghost" onclick="closeModal('agent-modal')">Cancel</button>
      <button class="btn-primary" id="agent-submit-btn" onclick="submitAgent()">Create</button>
    </div>
  </div>
</div>

<!-- User Modal -->
<div class="modal-overlay" id="user-modal">
  <div class="modal">
    <h3 id="user-modal-title">Create User</h3>
    <input type="hidden" id="user-edit-id">
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="user-email" placeholder="user@example.com">
    </div>
    <div class="form-group" id="user-password-group">
      <label>Password *</label>
      <input type="password" id="user-password" placeholder="Password">
    </div>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="user-name-input" placeholder="Full name">
    </div>
    <div class="form-group">
      <label>Role</label>
      <select id="user-role">
        <option value="member">member</option>
        <option value="org_admin">org_admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('user-modal')">Cancel</button>
      <button class="btn-primary" id="user-submit-btn" onclick="submitUser()">Create</button>
    </div>
  </div>
</div>

<!-- Add Team Member Modal -->
<div class="modal-overlay" id="add-member-modal">
  <div class="modal">
    <h3>Add Team Member</h3>
    <input type="hidden" id="add-member-team">
    <div class="form-group">
      <label>User</label>
      <select id="add-member-user"></select>
    </div>
    <div class="form-group">
      <label>Team Role</label>
      <select id="add-member-role">
        <option value="member">member</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('add-member-modal')">Cancel</button>
      <button class="btn-primary" onclick="submitAddMember()">Add</button>
    </div>
  </div>
</div>

<!-- Create Team Modal -->
<div class="modal-overlay" id="create-team-modal">
  <div class="modal">
    <h3>Create Team</h3>
    <div class="form-group">
      <label>Team Name *</label>
      <input type="text" id="create-team-name" placeholder="e.g. backend">
    </div>
    <div class="form-group">
      <label>First Admin *</label>
      <select id="create-team-admin"></select>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal('create-team-modal')">Cancel</button>
      <button class="btn-primary" onclick="submitCreateTeam()">Create</button>
    </div>
  </div>
</div>

<script>
// --- State ---
let authToken = localStorage.getItem('octroi_session_token') || '';
let authMode = ''; // 'session' when logged in
let currentUser = null; // { id, email, name, teams, role }
let isAdmin = false;
let usageAgentId = null;
let usageAgentName = null;
let usageToolId = null;
let usageToolName = null;
let usageTeamFilter = '';
let usageMode = 'live'; // 'live' or 'historical'
let usagePollTimer = null;
let lastTxnTimestamp = null;
let agentsCache = [];
let toolsCache = [];
let teamsCache = [];
let usersCache = [];

// --- API helpers ---
function apiBase() {
  return isAdmin ? '/api/v1/admin' : '/api/v1/member';
}

function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
  };
  if (body) opts.body = JSON.stringify(body);
  return fetch(path, opts).then(async r => {
    if (r.status === 204) return null;
    const data = await r.json();
    if (!r.ok) throw new Error((data.error && data.error.message) || r.statusText);
    return data;
  });
}

// --- Helpers for TeamMembership ---
function userTeamNames(u) {
  if (!u || !u.teams) return [];
  return u.teams.map(t => typeof t === 'string' ? t : t.team);
}

function userInTeam(u, team) {
  return userTeamNames(u).includes(team);
}

function canManageTeam(team) {
  if (!currentUser) return false;
  if (currentUser.role === 'org_admin') return true;
  if (!currentUser.teams) return false;
  return currentUser.teams.some(t => t.team === team && t.role === 'admin');
}

// --- Session persistence ---
function saveSession() {
  localStorage.setItem('octroi_session_token', authToken);
  if (currentUser) {
    localStorage.setItem('octroi_user', JSON.stringify(currentUser));
  } else {
    localStorage.removeItem('octroi_user');
  }
}

function clearSession() {
  localStorage.removeItem('octroi_session_token');
  localStorage.removeItem('octroi_user');
}

// --- Login ---
async function doLogin() {
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';

  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) return;
  try {
    const res = await fetch('/api/v1/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error((data.error && data.error.message) || 'Login failed');
    authToken = data.token;
    authMode = 'session';
    currentUser = data.user;
    isAdmin = currentUser.role === 'org_admin';
    saveSession();
    enterApp();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  }
}

function enterApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('tab-bar').style.display = 'flex';
  document.getElementById('main-content').style.display = 'block';

  // Topbar user info
  const infoEl = document.getElementById('user-info');
  infoEl.style.display = 'flex';
  const nameEl = document.getElementById('topbar-user-name');
  const badgeEl = document.getElementById('topbar-role-badge');
  if (currentUser) {
    nameEl.textContent = currentUser.name || currentUser.email;
    const roleLabel = currentUser.role === 'org_admin' ? 'org admin' : currentUser.role;
    badgeEl.textContent = roleLabel;
    badgeEl.className = 'role-badge' + (currentUser.role === 'org_admin' ? ' admin' : '');
  }

  // Permission-based UI: disable (not hide) actions the user can't perform.
  const adminOnlyBtns = ['tools-create-btn', 'teams-create-btn', 'users-create-btn'];
  adminOnlyBtns.forEach(id => {
    const btn = document.getElementById(id);
    btn.disabled = !isAdmin;
    btn.title = isAdmin ? '' : 'Org admin only';
  });
  if (!isAdmin) {
    // Hide agent team field for members (UX simplification, not permission)
    document.getElementById('agent-team-group').style.display = 'none';
  }

  loadAgents();
  loadTools();
  loadTeams();
  loadUsage();
  loadUsers();
  onHashChange();
}

async function logout() {
  stopUsagePoll();
  if (authMode === 'session') {
    try { await api('POST', '/api/v1/auth/logout'); } catch (e) { /* ignore */ }
  }
  authToken = '';
  authMode = '';
  currentUser = null;
  isAdmin = false;
  clearSession();
  location.reload();
}

// Handle Enter key in login fields
document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('login-email').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('login-password').focus(); });

// Auto-reconnect from stored session.
// Immediately enter app from cached user data, then validate in background.
(function autoConnect() {
  const storedToken = localStorage.getItem('octroi_session_token');
  if (!storedToken) return;

  authToken = storedToken;

  // Try to restore from cached user data immediately
  const cachedUser = localStorage.getItem('octroi_user');
  if (cachedUser) {
    try {
      currentUser = JSON.parse(cachedUser);
      authMode = 'session';
      isAdmin = currentUser.role === 'org_admin';
      enterApp();
    } catch (e) {
      // Bad cached data, fall through to async validation
    }
  }

  // Validate session and refresh user data
  api('GET', '/api/v1/auth/me').then(data => {
    const wasInApp = !!currentUser;
    currentUser = data;
    isAdmin = currentUser.role === 'org_admin';
    authMode = 'session';
    saveSession();
    if (!wasInApp) enterApp();
  }).catch(() => {
    clearSession();
    if (authMode) location.reload();
    authToken = '';
  });
})();

// --- Tabs (hash-routed) ---
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const btn = document.querySelector('[data-tab="' + tab + '"]');
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('tab-' + tab);
  if (panel) panel.classList.add('active');
  // Stop live polling when leaving usage tab.
  if (tab !== 'usage') stopUsagePoll();
  // Reload data when switching tabs.
  if (tab === 'usage') {
    loadUsage();
    if (usageMode === 'live') startUsagePoll();
  }
  else if (tab === 'agents') loadAgents();
  else if (tab === 'tools') loadTools();
  else if (tab === 'teams') loadTeams();
  else if (tab === 'users') loadUsers();
}

function navigateTo(hash) {
  location.hash = hash;
}

function onHashChange() {
  const hash = location.hash.replace('#', '') || 'agents';
  switchTab(hash);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => navigateTo(btn.dataset.tab));
});

window.addEventListener('hashchange', onHashChange);

// --- Tools ---
async function loadTools() {
  try {
    const path = isAdmin ? '/api/v1/admin/tools?limit=100' : '/api/v1/member/tools?limit=100';
    const data = await api('GET', path);
    toolsCache = data.tools || [];
    renderTools();
    populateToolFilter();
  } catch (e) { console.error('Failed to load tools', e); }
}

function renderTools() {
  const tbody = document.getElementById('tools-body');
  const empty = document.getElementById('tools-empty');
  if (!toolsCache.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  const disAttr = isAdmin ? '' : ' disabled title="Org admin only"';
  tbody.innerHTML = toolsCache.map(t => `<tr>
    <td><a href="#" onclick="viewToolUsage('${t.id}','${esc(t.name)}');return false" style="text-decoration:none;font-weight:700;border-bottom:1px solid var(--border)">${esc(t.name)}</a><br><span style="color:var(--text2);font-size:11px">${esc(t.description || '')}</span></td>
    <td class="mono">${isAdmin ? esc(t.endpoint || '\u2014') : esc(t.pricing_model || 'free')}</td>
    <td>${esc(t.auth_type || 'none')}</td>
    <td>${t.rate_limit || '\u2014'}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editTool('${t.id}')"${disAttr}>Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteTool('${t.id}','${esc(t.name)}')"${disAttr}>Delete</button>
    </td>
  </tr>`).join('');

  if (!isAdmin) {
    document.getElementById('tools-endpoint-th').textContent = 'Pricing';
  }
}

function openToolModal(tool) {
  document.getElementById('tool-edit-id').value = tool ? tool.id : '';
  document.getElementById('tool-modal-title').textContent = tool ? 'Edit Tool' : 'Create Tool';
  document.getElementById('tool-submit-btn').textContent = tool ? 'Save' : 'Create';
  document.getElementById('tool-name').value = tool ? tool.name : '';
  document.getElementById('tool-description').value = tool ? tool.description : '';
  document.getElementById('tool-endpoint').value = tool ? tool.endpoint || '' : '';
  document.getElementById('tool-auth-type').value = tool ? tool.auth_type || 'none' : 'none';
  document.getElementById('tool-rate-limit').value = tool ? tool.rate_limit || '' : '';
  document.getElementById('tool-auth-config').value = tool && tool.auth_config ? JSON.stringify(tool.auth_config) : '';
  document.getElementById('tool-pricing-model').value = tool ? tool.pricing_model || '' : '';
  document.getElementById('tool-pricing-amount').value = tool ? tool.pricing_amount || '' : '';
  document.getElementById('tool-pricing-currency').value = tool ? tool.pricing_currency || '' : '';
  document.getElementById('tool-budget-limit').value = tool ? tool.budget_limit || '' : '';
  document.getElementById('tool-budget-window').value = tool ? tool.budget_window || '' : '';
  document.getElementById('tool-modal').classList.add('open');
}

async function editTool(id) {
  const tool = toolsCache.find(t => t.id === id);
  if (tool) openToolModal(tool);
}

async function submitTool() {
  const id = document.getElementById('tool-edit-id').value;
  let authConfig = {};
  const authConfigRaw = document.getElementById('tool-auth-config').value.trim();
  if (authConfigRaw) {
    try { authConfig = JSON.parse(authConfigRaw); } catch { alert('Invalid auth config JSON'); return; }
  }
  const body = {
    name: document.getElementById('tool-name').value.trim(),
    description: document.getElementById('tool-description').value.trim(),
    endpoint: document.getElementById('tool-endpoint').value.trim(),
    auth_type: document.getElementById('tool-auth-type').value,
    auth_config: authConfig,
    pricing_model: document.getElementById('tool-pricing-model').value,
    pricing_amount: parseFloat(document.getElementById('tool-pricing-amount').value) || 0,
    pricing_currency: document.getElementById('tool-pricing-currency').value.trim(),
    rate_limit: parseInt(document.getElementById('tool-rate-limit').value) || 0,
    budget_limit: parseFloat(document.getElementById('tool-budget-limit').value) || 0,
    budget_window: document.getElementById('tool-budget-window').value.trim(),
  };
  try {
    if (id) {
      await api('PUT', '/api/v1/admin/tools/' + id, body);
    } else {
      await api('POST', '/api/v1/admin/tools', body);
    }
    closeModal('tool-modal');
    loadTools();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteTool(id, name) {
  if (!confirm('Delete tool "' + name + '"?')) return;
  try {
    await api('DELETE', '/api/v1/admin/tools/' + id);
    loadTools();
  } catch (e) { alert('Error: ' + e.message); }
}

// --- Agents ---
async function loadAgents() {
  try {
    const path = apiBase() + '/agents?limit=100';
    const data = await api('GET', path);
    agentsCache = data.agents || [];
    renderAgents();
    populateAgentFilter();
  } catch (e) { console.error('Failed to load agents', e); }
}

function renderAgents() {
  const tbody = document.getElementById('agents-body');
  const empty = document.getElementById('agents-empty');
  if (!agentsCache.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = agentsCache.map(a => `<tr>
    <td><a href="#" onclick="viewAgentUsage('${a.id}','${esc(a.name)}');return false" style="text-decoration:none;font-weight:700;border-bottom:1px solid var(--border)">${esc(a.name)}</a></td>
    <td>${esc(a.team || '\u2014')}</td>
    <td>${a.rate_limit || '\u2014'}</td>
    <td>${fmtDate(a.created_at)}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editAgent('${a.id}')">Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteAgent('${a.id}','${esc(a.name)}')">Delete</button>
    </td>
  </tr>`).join('');
}

function openAgentModal(ag) {
  document.getElementById('agent-edit-id').value = ag ? ag.id : '';
  document.getElementById('agent-modal-title').textContent = ag ? 'Edit Agent' : 'Create Agent';
  document.getElementById('agent-submit-btn').textContent = ag ? 'Save' : 'Create';
  document.getElementById('agent-name').value = ag ? ag.name : '';
  document.getElementById('agent-team').value = ag ? ag.team || '' : '';
  document.getElementById('agent-rate-limit').value = ag ? ag.rate_limit || '' : '';
  document.getElementById('agent-regen-btn').style.display = ag ? '' : 'none';
  // Show key prefix in edit mode
  const keyGroup = document.getElementById('agent-key-group');
  const keyDisplay = document.getElementById('agent-key-display');
  if (ag && ag.api_key_prefix) {
    keyDisplay.textContent = ag.api_key_prefix + '...';
    keyGroup.style.display = '';
  } else {
    keyGroup.style.display = 'none';
  }
  document.getElementById('agent-modal').classList.add('open');
}

function editAgent(id) {
  const ag = agentsCache.find(a => a.id === id);
  if (ag) openAgentModal(ag);
}

async function submitAgent() {
  const id = document.getElementById('agent-edit-id').value;
  const body = {
    name: document.getElementById('agent-name').value.trim(),
    team: document.getElementById('agent-team').value.trim(),
    rate_limit: parseInt(document.getElementById('agent-rate-limit').value) || 0,
  };
  try {
    if (id) {
      await api('PUT', apiBase() + '/agents/' + id, body);
      closeModal('agent-modal');
    } else {
      const res = await api('POST', apiBase() + '/agents', body);
      closeModal('agent-modal');
      if (res.api_key) {
        document.getElementById('agent-key-value').textContent = res.api_key;
        document.getElementById('agent-key-banner').classList.add('show');
      }
    }
    loadAgents();
  } catch (e) { alert('Error: ' + e.message); }
}

async function regenKeyFromModal() {
  const id = document.getElementById('agent-edit-id').value;
  const name = document.getElementById('agent-name').value;
  if (!id) return;
  if (!confirm('Regenerate API key for "' + name + '"? The old key will stop working immediately.')) return;
  try {
    const res = await api('POST', apiBase() + '/agents/' + id + '/regenerate-key');
    if (res.api_key) {
      document.getElementById('agent-key-value').textContent = res.api_key;
      document.getElementById('agent-key-banner').classList.add('show');
    }
    closeModal('agent-modal');
    loadAgents();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteAgent(id, name) {
  if (!confirm('Delete agent "' + name + '"?')) return;
  try {
    await api('DELETE', apiBase() + '/agents/' + id);
    loadAgents();
  } catch (e) { alert('Error: ' + e.message); }
}

// --- Teams ---
async function loadTeams() {
  try {
    const path = apiBase() + '/teams';
    const data = await api('GET', path);
    teamsCache = data.teams || [];
    renderTeams();
    populateTeamFilter();
  } catch (e) { console.error('Failed to load teams', e); }
}

function renderTeams() {
  const container = document.getElementById('teams-content');
  const empty = document.getElementById('teams-empty');
  if (!teamsCache.length) { container.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  container.innerHTML = teamsCache.map(t => {
    const canManage = canManageTeam(t.name);
    const agentList = t.agents.length
      ? t.agents.map(a => `<li><strong>${esc(a.name)}</strong></li>`).join('')
      : '<li style="color:var(--text2)">No agents</li>';
    const userList = t.users.length
      ? t.users.map(u => {
          const globalBadge = u.role === 'org_admin'
            ? `<span class="role-badge admin" style="font-size:9px">org admin</span>`
            : '';
          const teamBadge = `<span class="role-badge${u.team_role === 'admin' ? ' admin' : ''}" style="font-size:9px">${esc(u.team_role || 'member')}</span>`;
          const removeDis = canManage ? '' : ' disabled title="Team admin or org admin only"';
          return `<li><strong>${esc(u.name || u.email)}</strong> &lt;${esc(u.email)}&gt; ${teamBadge} ${globalBadge} <button class="btn-danger btn-sm" onclick="removeTeamMember('${esc(t.name)}','${u.id}','${esc(u.name || u.email)}')"${removeDis}>Remove</button></li>`;
        }).join('')
      : '<li style="color:var(--text2)">No users</li>';

    const addDis = canManage ? '' : ' disabled title="Team admin or org admin only"';
    const addBtn = `<button class="btn-ghost btn-sm" onclick="openAddMemberModal('${esc(t.name)}')"${addDis}>+ Add Member</button>`;

    return `<div class="team-section">
      <h3>${esc(t.name)}</h3>
      <div class="team-sub">Agents (${t.agents.length})</div>
      <ul>${agentList}</ul>
      <div class="team-sub">Users (${t.users.length}) ${addBtn}</div>
      <ul>${userList}</ul>
    </div>`;
  }).join('');
}

function openAddMemberModal(team) {
  document.getElementById('add-member-team').value = team;
  document.getElementById('add-member-role').value = 'member';
  // Populate user dropdown, excluding users already in this team.
  const sel = document.getElementById('add-member-user');
  const teamData = teamsCache.find(t => t.name === team);
  const existingIds = new Set(teamData ? teamData.users.map(u => u.id) : []);
  const available = (usersCache.length ? usersCache : []).filter(u => !existingIds.has(u.id) && u.role !== 'org_admin');
  sel.innerHTML = available.map(u => `<option value="${u.id}">${esc(u.name || u.email)} (${esc(u.email)})</option>`).join('');
  if (!available.length) {
    sel.innerHTML = '<option value="">No users available</option>';
  }
  document.getElementById('add-member-modal').classList.add('open');
}

async function submitAddMember() {
  const team = document.getElementById('add-member-team').value;
  const userId = document.getElementById('add-member-user').value;
  const role = document.getElementById('add-member-role').value;
  if (!userId) return;
  try {
    await api('PUT', '/api/v1/member/teams/' + encodeURIComponent(team) + '/members/' + userId, { role });
    closeModal('add-member-modal');
    loadTeams();
    loadUsers();
  } catch (e) { alert('Error: ' + e.message); }
}

async function removeTeamMember(team, userId, userName) {
  if (!confirm('Remove "' + userName + '" from team "' + team + '"?')) return;
  try {
    await api('DELETE', '/api/v1/member/teams/' + encodeURIComponent(team) + '/members/' + userId);
    loadTeams();
    loadUsers();
  } catch (e) { alert('Error: ' + e.message); }
}

function openCreateTeamModal() {
  document.getElementById('create-team-name').value = '';
  const sel = document.getElementById('create-team-admin');
  const eligible = (usersCache.length ? usersCache : []).filter(u => u.role !== 'org_admin');
  sel.innerHTML = eligible.map(u => `<option value="${u.id}">${esc(u.name || u.email)} (${esc(u.email)})</option>`).join('');
  if (!eligible.length) {
    sel.innerHTML = '<option value="">No eligible users</option>';
  }
  document.getElementById('create-team-modal').classList.add('open');
}

async function submitCreateTeam() {
  const name = document.getElementById('create-team-name').value.trim();
  const userId = document.getElementById('create-team-admin').value;
  if (!name) { alert('Team name is required'); return; }
  if (!userId) { alert('A first admin is required'); return; }
  // Check if team already exists
  if (teamsCache.some(t => t.name === name)) { alert('Team "' + name + '" already exists'); return; }
  try {
    await api('PUT', '/api/v1/member/teams/' + encodeURIComponent(name) + '/members/' + userId, { role: 'admin' });
    closeModal('create-team-modal');
    loadTeams();
    loadUsers();
  } catch (e) { alert('Error: ' + e.message); }
}

function populateTeamFilter() {
  const sel = document.getElementById('usage-team-select');
  const current = sel.value;
  sel.innerHTML = '<option value="">All teams</option>' +
    teamsCache.map(t => `<option value="${esc(t.name)}">${esc(t.name)}</option>`).join('');
  sel.value = current;
}

// --- Usage Mode (Live / Historical) ---
function setUsageMode(mode) {
  usageMode = mode;
  document.getElementById('mode-live').classList.toggle('active', mode === 'live');
  document.getElementById('mode-hist').classList.toggle('active', mode === 'historical');
  const dateControls = document.getElementById('usage-date-controls');
  dateControls.style.display = mode === 'historical' ? 'flex' : 'none';
  if (mode === 'live') {
    lastTxnTimestamp = null;
    startUsagePoll();
  } else {
    stopUsagePoll();
  }
  loadUsage();
}

function startUsagePoll() {
  stopUsagePoll();
  usagePollTimer = setInterval(loadUsageLive, 3000);
}

function stopUsagePoll() {
  if (usagePollTimer) { clearInterval(usagePollTimer); usagePollTimer = null; }
}

async function loadUsageLive() {
  const from = new Date(Date.now() - 5 * 60 * 1000).toISOString();
  let qs = '&from=' + encodeURIComponent(from);

  if (isAdmin) {
    let usagePath = '/api/v1/admin/usage';
    let txnQs = qs;
    if (usageTeamFilter) {
      qs += '&team=' + encodeURIComponent(usageTeamFilter);
      txnQs += '&team=' + encodeURIComponent(usageTeamFilter);
    }
    if (usageAgentId && usageToolId) {
      usagePath = '/api/v1/admin/usage/agents/' + usageAgentId + '/tools/' + usageToolId;
      txnQs += '&agent_id=' + usageAgentId + '&tool_id=' + usageToolId;
    } else if (usageAgentId) {
      usagePath = '/api/v1/admin/usage/agents/' + usageAgentId;
      txnQs += '&agent_id=' + usageAgentId;
    } else if (usageToolId) {
      usagePath = '/api/v1/admin/usage/tools/' + usageToolId;
      txnQs += '&tool_id=' + usageToolId;
    }
    try {
      const [summary, txns] = await Promise.all([
        api('GET', usagePath + '?' + qs),
        api('GET', '/api/v1/admin/usage/transactions?limit=50' + txnQs),
      ]);
      renderUsageSummary(summary);
      renderTransactionsLive(txns.transactions || []);
    } catch (e) { console.error('Failed to load live usage', e); }
  } else {
    let memberQs = qs;
    if (usageTeamFilter) {
      memberQs += '&team=' + encodeURIComponent(usageTeamFilter);
    }
    try {
      const [summary, txns] = await Promise.all([
        api('GET', '/api/v1/member/usage?' + memberQs),
        api('GET', '/api/v1/member/usage/transactions?limit=50' + memberQs),
      ]);
      renderUsageSummary(summary);
      renderTransactionsLive(txns.transactions || []);
    } catch (e) { console.error('Failed to load live usage', e); }
  }
}

function renderTransactionsLive(txns) {
  const tbody = document.getElementById('txn-body');
  const empty = document.getElementById('txn-empty');
  if (!txns.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  const prevTimestamp = lastTxnTimestamp;
  if (txns.length) lastTxnTimestamp = txns[0].timestamp;
  tbody.innerHTML = txns.map(t => {
    const isNew = prevTimestamp && t.timestamp > prevTimestamp;
    return `<tr${isNew ? ' class="txn-new"' : ''}>
    <td style="white-space:nowrap">${fmtTime(t.timestamp)}</td>
    <td>${esc(resolveAgentName(t.agent_id))}</td>
    <td>${esc(resolveToolName(t.tool_id))}</td>
    <td>${esc(t.method)}</td>
    <td style="color:${t.success ? 'var(--success)' : 'var(--danger)'}">${t.status_code}</td>
    <td>${t.latency_ms}ms</td>
    <td>$${(t.cost || 0).toFixed(4)}</td>
  </tr>`;
  }).join('');
}

// --- Usage ---
function viewAgentUsage(agentId, agentName) {
  usageAgentId = agentId;
  usageAgentName = agentName;
  document.getElementById('usage-agent-select').value = agentId;
  navigateTo('usage');
  loadUsage();
}

function onAgentFilterChange() {
  const sel = document.getElementById('usage-agent-select');
  usageAgentId = sel.value || null;
  usageAgentName = sel.value ? sel.options[sel.selectedIndex].text : null;
  loadUsage();
}

function onTeamFilterChange() {
  const sel = document.getElementById('usage-team-select');
  usageTeamFilter = sel.value || '';
  loadUsage();
}

function populateAgentFilter() {
  const sel = document.getElementById('usage-agent-select');
  const current = sel.value;
  sel.innerHTML = '<option value="">All agents</option>' +
    agentsCache.map(a => `<option value="${a.id}">${esc(a.name)}</option>`).join('');
  sel.value = current;
}

function viewToolUsage(toolId, toolName) {
  usageToolId = toolId;
  usageToolName = toolName;
  document.getElementById('usage-tool-select').value = toolId;
  navigateTo('usage');
  loadUsage();
}

function onToolFilterChange() {
  const sel = document.getElementById('usage-tool-select');
  usageToolId = sel.value || null;
  usageToolName = sel.value ? sel.options[sel.selectedIndex].text : null;
  loadUsage();
}

function populateToolFilter() {
  const sel = document.getElementById('usage-tool-select');
  const current = sel.value;
  sel.innerHTML = '<option value="">All tools</option>' +
    toolsCache.map(t => `<option value="${t.id}">${esc(t.name)}</option>`).join('');
  sel.value = current;
}

async function loadUsage() {
  if (usageMode === 'live') { loadUsageLive(); return; }
  const from = document.getElementById('usage-from').value;
  const to = document.getElementById('usage-to').value;
  let qs = '';
  if (from) qs += '&from=' + from;
  if (to) qs += '&to=' + to;

  if (isAdmin) {
    // Admin: use admin usage endpoints
    let usagePath = '/api/v1/admin/usage';
    let txnQs = qs;

    // Team filter
    if (usageTeamFilter) {
      qs += '&team=' + encodeURIComponent(usageTeamFilter);
      txnQs += '&team=' + encodeURIComponent(usageTeamFilter);
    }

    if (usageAgentId && usageToolId) {
      usagePath = '/api/v1/admin/usage/agents/' + usageAgentId + '/tools/' + usageToolId;
      txnQs += '&agent_id=' + usageAgentId + '&tool_id=' + usageToolId;
    } else if (usageAgentId) {
      usagePath = '/api/v1/admin/usage/agents/' + usageAgentId;
      txnQs += '&agent_id=' + usageAgentId;
    } else if (usageToolId) {
      usagePath = '/api/v1/admin/usage/tools/' + usageToolId;
      txnQs += '&tool_id=' + usageToolId;
    }
    try {
      const [summary, txns] = await Promise.all([
        api('GET', usagePath + '?' + qs),
        api('GET', '/api/v1/admin/usage/transactions?limit=50' + txnQs),
      ]);
      renderUsageSummary(summary);
      renderTransactions(txns.transactions || []);
    } catch (e) { console.error('Failed to load usage', e); }
  } else {
    // Member: use member usage endpoints (team-scoped)
    let memberQs = qs;
    if (usageTeamFilter) {
      memberQs += '&team=' + encodeURIComponent(usageTeamFilter);
    }
    try {
      const [summary, txns] = await Promise.all([
        api('GET', '/api/v1/member/usage?' + memberQs),
        api('GET', '/api/v1/member/usage/transactions?limit=50' + memberQs),
      ]);
      renderUsageSummary(summary);
      renderTransactions(txns.transactions || []);
    } catch (e) { console.error('Failed to load usage', e); }
  }
}

function renderUsageSummary(summary) {
  document.getElementById('stat-requests').textContent = summary.total_requests ?? 0;
  document.getElementById('stat-cost').textContent = '$' + (summary.total_cost ?? 0).toFixed(4);
  document.getElementById('stat-results').textContent = (summary.success_count ?? 0) + ' / ' + (summary.error_count ?? 0);
  document.getElementById('stat-latency').textContent = (summary.avg_latency_ms ?? 0).toFixed(1) + 'ms';
}

function renderTransactions(txns) {
  const tbody = document.getElementById('txn-body');
  const empty = document.getElementById('txn-empty');
  if (!txns.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = txns.map(t => `<tr>
    <td style="white-space:nowrap">${fmtTime(t.timestamp)}</td>
    <td>${esc(resolveAgentName(t.agent_id))}</td>
    <td>${esc(resolveToolName(t.tool_id))}</td>
    <td>${esc(t.method)}</td>
    <td style="color:${t.success ? 'var(--success)' : 'var(--danger)'}">${t.status_code}</td>
    <td>${t.latency_ms}ms</td>
    <td>$${(t.cost || 0).toFixed(4)}</td>
  </tr>`).join('');
}

// --- Users ---
async function loadUsers() {
  try {
    const path = isAdmin ? '/api/v1/admin/users' : '/api/v1/member/users';
    const data = await api('GET', path);
    usersCache = data.users || [];
    // Sort current user to top.
    if (currentUser) {
      usersCache.sort((a, b) => {
        if (a.id === currentUser.id) return -1;
        if (b.id === currentUser.id) return 1;
        return 0;
      });
    }
    renderUsers();
  } catch (e) { console.error('Failed to load users', e); }
}

function renderUsers() {
  const tbody = document.getElementById('users-body');
  const empty = document.getElementById('users-empty');
  if (!usersCache.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = usersCache.map(u => {
    const teamsStr = (u.teams && u.teams.length)
      ? u.teams.map(t => t.team + ':' + t.role).join(', ')
      : '\u2014';
    const roleLabel = u.role === 'org_admin' ? 'org admin' : u.role;
    const isSelf = currentUser && u.id === currentUser.id;
    const canEdit = isAdmin || isSelf;
    const canDelete = isAdmin && !isSelf;
    const editAttr = canEdit ? '' : ' disabled title="You can only edit your own profile"';
    const deleteAttr = canDelete ? '' : (isSelf ? ' disabled title="Cannot delete yourself"' : ' disabled title="Org admin only"');
    return `<tr${isSelf ? ' style="background:var(--surface)"' : ''}>
    <td style="font-weight:600">${esc(u.email)}${isSelf ? ' <span style="font-size:9px;color:var(--text2)">(you)</span>' : ''}</td>
    <td>${esc(u.name || '\u2014')}</td>
    <td>${esc(teamsStr)}</td>
    <td><span class="role-badge${u.role === 'org_admin' ? ' admin' : ''}">${esc(roleLabel)}</span></td>
    <td>${fmtDate(u.created_at)}</td>
    <td style="white-space:nowrap">
      <button class="btn-ghost btn-sm" onclick="editUser('${u.id}')"${editAttr}>Edit</button>
      <button class="btn-danger btn-sm" onclick="deleteUser('${u.id}','${esc(u.email)}')"${deleteAttr}>Delete</button>
    </td>
  </tr>`;
  }).join('');
}

function openUserModal(u) {
  const isSelfEdit = u && currentUser && u.id === currentUser.id && !isAdmin;
  document.getElementById('user-edit-id').value = u ? u.id : '';
  document.getElementById('user-modal-title').textContent = u ? 'Edit User' : 'Create User';
  document.getElementById('user-submit-btn').textContent = u ? 'Save' : 'Create';
  document.getElementById('user-email').value = u ? u.email : '';
  document.getElementById('user-email').disabled = isSelfEdit;
  document.getElementById('user-password').value = '';
  document.getElementById('user-name-input').value = u ? u.name || '' : '';
  document.getElementById('user-role').value = u ? u.role || 'member' : 'member';
  document.getElementById('user-role').disabled = isSelfEdit;
  // Password is optional when editing
  document.getElementById('user-password-group').querySelector('label').textContent = u ? 'Password (leave blank to keep)' : 'Password *';
  document.getElementById('user-modal').classList.add('open');
}

function editUser(id) {
  const u = usersCache.find(u => u.id === id);
  if (u) openUserModal(u);
}

async function submitUser() {
  const id = document.getElementById('user-edit-id').value;
  const email = document.getElementById('user-email').value.trim();
  const password = document.getElementById('user-password').value;
  const name = document.getElementById('user-name-input').value.trim();
  const role = document.getElementById('user-role').value;

  if (id) {
    const isSelf = currentUser && id === currentUser.id;
    if (!isAdmin && isSelf) {
      // Member self-edit: only name and password via member endpoint.
      const body = {};
      if (name !== undefined) body.name = name;
      if (password) body.password = password;
      try {
        await api('PUT', '/api/v1/member/users/me', body);
        closeModal('user-modal');
        // Update cached currentUser name.
        if (body.name !== undefined) {
          currentUser.name = body.name;
          document.querySelector('.user-name').textContent = currentUser.name || currentUser.email;
          saveSession();
        }
        loadUsers();
      } catch (e) { alert('Error: ' + e.message); }
    } else {
      const body = {};
      if (email) body.email = email;
      if (password) body.password = password;
      if (name !== undefined) body.name = name;
      if (role) body.role = role;
      try {
        await api('PUT', '/api/v1/admin/users/' + id, body);
        closeModal('user-modal');
        loadUsers();
      } catch (e) { alert('Error: ' + e.message); }
    }
  } else {
    if (!email || !password) { alert('Email and password are required'); return; }
    const body = { email, password, name, role };
    try {
      await api('POST', '/api/v1/admin/users', body);
      closeModal('user-modal');
      loadUsers();
    } catch (e) { alert('Error: ' + e.message); }
  }
}

async function deleteUser(id, email) {
  if (!confirm('Delete user "' + email + '"?')) return;
  try {
    await api('DELETE', '/api/v1/admin/users/' + id);
    loadUsers();
  } catch (e) { alert('Error: ' + e.message); }
}

// --- Helpers ---
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtDate(s) { if (!s) return '\u2014'; return new Date(s).toLocaleDateString(); }
function fmtTime(s) { if (!s) return '\u2014'; const d = new Date(s); return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); }
function resolveAgentName(id) { const a = agentsCache.find(a => a.id === id); return a ? a.name : id.slice(0,8); }
function resolveToolName(id) { const t = toolsCache.find(t => t.id === id); return t ? t.name : id.slice(0,8); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// Set default date range to last 7 days
const now = new Date();
const tomorrow = new Date(now);
tomorrow.setDate(tomorrow.getDate() + 1);
const weekAgo = new Date(now);
weekAgo.setDate(weekAgo.getDate() - 7);
document.getElementById('usage-to').value = tomorrow.toISOString().slice(0, 10);
document.getElementById('usage-from').value = weekAgo.toISOString().slice(0, 10);
</script>
</body>
</html>
